<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>北海道本格ジンギスカン ひつじや｜ご注文</title>

  <style>
    :root{
      --bg:#0b0d10;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.58);
      --gold:#c8a45a;
      --danger:#a40000;
      --danger2:#7c0000;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;

      --pad-desktop: 26px;
      --pad-mobile: 14px;

      --title: clamp(20px, 4.6vw, 30px);
      --subtitle: clamp(12px, 2.6vw, 14px);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(200,164,90,.12), transparent 70%),
                  radial-gradient(900px 500px at 90% 0%, rgba(200,164,90,.08), transparent 70%),
                  var(--bg);
      color:var(--text);
      font-size: 14px;
      overflow-x: hidden;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:var(--pad-desktop) 16px 86px; }

    header{
      padding:10px 0 18px;
      border-bottom: 1px solid var(--line);
      margin-bottom:14px;
      position: relative;
    }

    .title{
      font-size:var(--title);
      font-weight:1000;
      letter-spacing:.02em;
      color:var(--gold);
      margin:0 0 6px;
      line-height:1.15;
    }

    .sub{
      margin:0;
      color:var(--muted);
      font-size:var(--subtitle);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
    .pill strong{ color:var(--text); }

    .title-with-sheep{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:nowrap;
    }
    .title-text{
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:min(92vw, 680px);
    }
    @media (max-width: 480px){
      .title-text{
        white-space:normal;
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        max-width: 92vw;
      }
    }
    .sheep-icon{
      width:30px;
      height:30px;
      flex:0 0 auto;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.45));
      opacity:.95;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .layout{ grid-template-columns: 240px 1fr 360px; align-items:start; }
    }

    /* Left category nav (PC) */
    .navCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: sticky;
      top: 14px;
    }
    .navTitle{
      padding:14px 14px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
    }
    .navList{ display:flex; flex-direction:column; gap:8px; padding:12px; }
    .navBtn{
      display:flex; justify-content:space-between; align-items:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      text-decoration:none;
      font-weight:900;
      transition:.15s;
      cursor: pointer;
    }
    .navBtn:hover{ background: rgba(200,164,90,.10); border-color: rgba(200,164,90,.35); }
    .navBtn small{ color:var(--muted); font-weight:800; }

    @media (max-width: 979px){
      .navCard{ display:none; }
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelTitle{
      padding:14px 16px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
    }

    /* Menu area */
    .menuWrap{ padding:14px; }
    .section{ margin: 8px 0 18px; scroll-margin-top: 70px; }
    .sectionHead{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px;
      padding:10px 10px 12px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .sectionHead h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.03em;
      color: var(--text);
    }
    .sectionHead p{ margin:0; font-size:12px; color: var(--muted); }

    /* 商品は常に2列 */
    .menuGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .itemCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 240px;
      position:relative;
      overflow:hidden;
    }

    .imgBox{
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .itemCard h3{
      margin:0;
      font-size:15px;
      font-weight:1000;
      letter-spacing:.02em;
      line-height:1.2;
    }
    .desc{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      min-height: 16px;
    }
    .price{
      margin:0;
      font-size:15px;
      font-weight:1000;
      color:var(--gold);
    }

    /* ✅ はみ出し対策（スマホ） */
    .stepRow{
      margin-top:auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap; /* 重要 */
    }
    .stepper{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:6px 8px;
      flex: 1 1 160px; /* 重要 */
      min-width: 160px;
      justify-content:center;
    }
    .stepBtn{
      width:36px; height:36px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      font-size:18px;
      flex:0 0 auto;
    }
    .stepQty{
      min-width: 22px;
      text-align:center;
      font-weight:1000;
      font-size: 16px;
      flex:0 0 auto;
    }

    .addBtn{
      border:1px solid rgba(200,164,90,.65);
      background: rgba(200,164,90,.10);
      color: var(--gold);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:1000;
      cursor:pointer;
      transition: .15s;
      white-space:nowrap;
      height: 44px;
      flex: 1 1 160px; /* 重要 */
      min-width: 160px;
    }
    .addBtn:hover{ background: rgba(200,164,90,.16); }
    .addBtn:active{ transform: translateY(1px); }
    .addBtn:disabled{ opacity:.5; cursor:not-allowed; }

    @media (max-width: 420px){
      .stepRow{ gap:8px; }
      .stepper, .addBtn{ flex: 1 1 100%; min-width: 0; }
    }

    .soldBadge{
      position:absolute;
      top:10px; left:10px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(164,0,0,.85);
      border:1px solid rgba(255,255,255,.16);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.08em;
    }
    .soldOverlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
      pointer-events:none;
    }

    /* Cart */
    .cartBody{ padding:14px 16px 16px; position: sticky; top: 14px; }
    @media (max-width: 979px){
      .cartBody{ position: static; }
    }

    .cartList{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .cartRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.20);
    }
    .cartName{ font-weight:1000; font-size:14px; line-height:1.25; }
    .cartMeta{ color:var(--muted); font-size:12px; margin-top:2px; }

    .qtyBox{ display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .qtyBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      font-size: 18px;
    }
    .qtyBtn:hover{ background: rgba(255,255,255,.06); }

    .qty{
      min-width: 26px;
      text-align:center;
      font-weight:1000;
      font-size: 18px;
    }

    .sumRow{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-weight:900;
      font-size: 14px;
    }
    .sumVal{ color:var(--gold); font-size:22px; font-weight:1000; }

    .orderBtn{
      margin-top:12px;
      width:100%;
      border:0;
      background: linear-gradient(180deg, var(--danger), var(--danger2));
      color:#fff;
      font-weight:1000;
      letter-spacing:.08em;
      padding:16px 14px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(164,0,0,.35);
      transition:.15s;
    }
    .orderBtn:hover{ filter: brightness(1.03); }
    .orderBtn:active{ transform: translateY(1px); }
    .orderBtn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .ghostBtn{
      margin-top:10px;
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.9);
      font-weight:1000;
      padding:12px 14px;
      border-radius: 16px;
      cursor:pointer;
    }
    .ghostBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .foot{ margin-top:18px; text-align:center; color:rgba(255,255,255,.45); font-size:12px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:70px;
      transform:translateX(-50%);
      background: rgba(16,19,24,.92);
      border:1px solid var(--line);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-weight:900;
      display:none;
      max-width:min(560px, 92vw);
      z-index:9999;
      text-align:center;
    }

    /* ===== Mobile drawer (hamburger) ===== */
    .hamburger{
      display:none;
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 1002;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      gap: 3px;
      flex-direction: column;
    }
    .hamburger span{
      width: 18px;
      height: 2px;
      background: rgba(255,255,255,.85);
      border-radius: 2px;
      display:block;
    }

    .drawerOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .drawerOverlay.show{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      left: 0;
      height: 100dvh;
      width: min(320px, 86vw);
      z-index: 1001;
      transform: translateX(-102%);
      transition: transform .18s ease;
      padding: calc(14px + env(safe-area-inset-top)) 14px 14px; /* ✅ 上が見切れない */
      background: rgba(10,12,16,.92);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:auto;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 6px 4px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .drawerTitle{
      font-weight: 1000;
      color: var(--gold);
      letter-spacing: .04em;
    }
    .drawerClose{
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.9);
      font-size: 18px;
      cursor: pointer;
    }

    /* ===== Bottom Nav (Order / History) ===== */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(10,12,16,.82);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,.10);
      z-index: 9998;
    }
    .tabs{
      display:flex;
      gap:10px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .tabBtn{
      flex:1;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.9);
      padding: 12px 10px;
      border-radius: 14px;
      font-weight: 1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .tabBtn.active{
      border-color: rgba(200,164,90,.45);
      background: rgba(200,164,90,.10);
      color: var(--gold);
    }
    .badge{
      min-width: 22px;
      height: 22px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.9);
      font-size: 12px;
      font-weight:1000;
      padding: 0 6px;
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* History / Admin panels */
    .simpleList{ margin:0; padding:14px; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .simpleRow{
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      padding: 12px;
    }
    .rowTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .rowTitle{ font-weight:1000; }
    .rowMeta{ color: var(--muted); font-size:12px; }
    .mini{ font-size:12px; color: var(--muted); margin-top:8px; line-height:1.4; }

    .adminBox{ padding:14px; }

    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-top:10px;
    }
    .field label{ color: var(--muted); font-size:12px; font-weight:900; }
    .inp{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      outline: none;
    }

    .toggleRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
    }
    .toggleRow strong{ font-size:13px; }
    .sw{
      width:48px; height:28px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .sw::after{
      content:"";
      width:22px; height:22px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      position:absolute;
      top:2px; left:2px;
      transition: .15s;
    }
    .sw.on{
      border-color: rgba(200,164,90,.45);
      background: rgba(200,164,90,.14);
    }
    .sw.on::after{
      left:24px;
      background: rgba(200,164,90,.95);
    }

    /* ✅ 708はログイン必須：ゲート */
    .gate{
      position:fixed;
      inset:0;
      z-index: 20000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
    }
    .gate.show{ display:flex; }
    .gateCard{
      width:min(560px, 94vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,12,16,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .gateHead{
      padding:14px 16px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
    }
    .gateBody{ padding:14px 16px 16px; }

    /* ✅ 管理画面を「会計＆履歴無効化 / 品切れ / 注文管理」に分割 */
    .adminSection{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    .adminSectionHead{
      padding:12px 14px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
    }
    .adminSectionBody{ padding:12px 14px; }

    @media (max-width: 979px){
      .wrap{ padding: var(--pad-mobile) 12px 96px; }
      header{ padding: 8px 0 14px; margin-bottom: 14px; }
      .menuWrap{ padding: 12px; }
      .panelTitle{ padding: 12px 14px; }
      .cartBody{ padding: 12px 14px 14px; }
      .card{ box-shadow: 0 10px 30px rgba(0,0,0,.45); }
      .hamburger{ display:flex; }
    }
  </style>
</head>

<body>
  <!-- スマホ用ハンバーガー＆ドロワー -->
  <button id="hamburger" class="hamburger" aria-label="カテゴリを開く">
    <span></span><span></span><span></span>
  </button>
  <div id="drawerOverlay" class="drawerOverlay"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawerHead">
      <div class="drawerTitle">カテゴリ</div>
      <button id="drawerClose" class="drawerClose" aria-label="閉じる">×</button>
    </div>
    <div id="drawerNav" class="navList"></div>
  </aside>

  <!-- ✅ 708ログイン必須ゲート -->
  <div id="adminGate" class="gate" aria-hidden="true">
    <div class="gateCard">
      <div class="gateHead">テーブル708（スタッフ用）ログイン必須</div>
      <div class="gateBody">
        <div class="rowMeta">メールとパスワードが必須です。</div>
        <div class="field">
          <label>管理者メール</label>
          <input id="gateEmail" class="inp" type="email" placeholder="例: xxx@gmail.com" />
        </div>
        <div class="field">
          <label>パスワード</label>
          <input id="gatePass" class="inp" type="password" placeholder="********" />
        </div>
        <button id="gateLoginBtn" class="orderBtn" style="margin-top:12px; box-shadow:none;">ログイン</button>
        <div class="mini" id="gateMsg" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1 class="title title-with-sheep">
        <span class="sheep-icon" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <g fill="none" stroke="none">
              <ellipse cx="30" cy="34" rx="18" ry="14" fill="#f5f5f5"/>
              <circle cx="18" cy="30" r="6" fill="#f5f5f5"/>
              <circle cx="42" cy="30" r="6" fill="#f5f5f5"/>
              <ellipse cx="44" cy="38" rx="9" ry="8" fill="#3b2f2a"/>
              <circle cx="41" cy="35" r="1.5" fill="#fff"/>
              <circle cx="47" cy="35" r="1.5" fill="#fff"/>
              <circle cx="41" cy="35" r="0.7" fill="#000"/>
              <circle cx="47" cy="35" r="0.7" fill="#000"/>
              <path d="M43 40c2 2 4 2 6 0" stroke="#000" stroke-width="1.3" stroke-linecap="round"/>
              <path d="M38 31c-3-6 3-10 6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <path d="M50 31c3-6-3-10-6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <rect x="22" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
              <rect x="33" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
            </g>
          </svg>
        </span>

        <span class="title-text">北海道本格ジンギスカン　ひつじや</span>

        <span class="sheep-icon" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(64,0) scale(-1,1)">
              <ellipse cx="30" cy="34" rx="18" ry="14" fill="#f5f5f5"/>
              <circle cx="18" cy="30" r="6" fill="#f5f5f5"/>
              <circle cx="42" cy="30" r="6" fill="#f5f5f5"/>
              <ellipse cx="44" cy="38" rx="9" ry="8" fill="#3b2f2a"/>
              <circle cx="41" cy="35" r="1.5" fill="#fff"/>
              <circle cx="47" cy="35" r="1.5" fill="#fff"/>
              <circle cx="41" cy="35" r="0.7" fill="#000"/>
              <circle cx="47" cy="35" r="0.7" fill="#000"/>
              <path d="M43 40c2 2 4 2 6 0" stroke="#000" stroke-width="1.3" stroke-linecap="round"/>
              <path d="M38 31c-3-6 3-10 6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <path d="M50 31c3-6-3-10-6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <rect x="22" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
              <rect x="33" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
            </g>
          </svg>
        </span>
      </h1>

      <p class="sub">ごゆっくりお選びください</p>

      <!-- ✅ セッション表示は使うが、お客画面では非表示にする（JSで常に display:none） -->
      <div class="pill" id="sessionPill" style="display:none;">
        セッション <strong id="sessionText">-</strong>
      </div>

      <div id="tablePill" class="pill" style="display:none;">
        テーブル <strong id="tableNo">-</strong>
      </div>
    </header>

    <!-- ====== VIEW: Order (menu + cart) ====== -->
    <div id="viewOrder" class="view active">
      <div class="layout">
        <!-- 左：カテゴリ（PC用） -->
        <aside class="navCard">
          <div class="navTitle">カテゴリ</div>
          <div id="catNav" class="navList"></div>
        </aside>

        <!-- 中：メニュー -->
        <section class="card">
          <div class="panelTitle">メニュー</div>
          <div class="menuWrap" id="menu"></div>
        </section>

        <!-- 右：カート -->
        <section class="card" id="order-content">
          <div class="panelTitle">ご注文内容</div>
          <div class="cartBody">
            <ul id="cartList" class="cartList"></ul>

            <div class="sumRow">
              <span>合計</span>
              <span id="total" class="sumVal">¥0</span>
            </div>

            <button id="orderBtn" class="orderBtn" disabled>この内容で注文</button>
          </div>
        </section>
      </div>
    </div>

    <!-- ====== VIEW: History ====== -->
    <div id="viewHistory" class="view">
      <section class="card">
        <div class="panelTitle">注文履歴</div>
        <ul id="historyList" class="simpleList"></ul>
      </section>
    </div>

    <!-- ====== VIEW: Admin (708 only) ====== -->
    <div id="viewAdmin" class="view">
      <section class="card">
        <div class="panelTitle">管理（テーブル708 スタッフ用）</div>
        <div class="adminBox">
          <div class="rowMeta" style="margin-top:2px;">
            ※ テーブル708はログイン必須です。
          </div>

          <div id="adminStatus" class="mini"></div>

          <div id="adminActions" style="display:none;">

            <div class="adminSection">
              <div class="adminSectionHead">会計＆履歴無効化（テーブル別）</div>
              <div class="adminSectionBody">
                <div class="mini">各テーブルの sessionId を新しくして、直前セッションの注文を status=cleared にします（履歴から非表示）。</div>
                <div id="resetList" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
              </div>
            </div>

            <div class="adminSection">
              <div class="adminSectionHead">品切れ ON/OFF（全テーブル共通）</div>
              <div class="adminSectionBody">
                <div class="mini">ここでONにすると、テーブル1〜12のお客様画面でも「品切れ」になり追加できません。</div>
                <div id="stockList" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
              </div>
            </div>

            <div class="adminSection">
              <div class="adminSectionHead">注文管理（テーブル1〜12）</div>
              <div class="adminSectionBody">
                <div class="mini">お客の注文／会計通知がここに集約されます。</div>

                <div class="tabs" style="margin-top:10px;">
                  <button id="adminTabNew" class="tabBtn active">未完了 <span id="cntNew" class="badge">0</span></button>
                  <button id="adminTabDone" class="tabBtn">完了 <span id="cntDone" class="badge">0</span></button>
                  <button id="adminTabAll" class="tabBtn">一覧 <span id="cntAll" class="badge">0</span></button>
                </div>

                <ul id="adminOrdersList" class="simpleList" style="padding:12px 0 0;"></ul>

                <div style="margin-top:10px;">
                  <button id="logoutBtn" class="ghostBtn" style="margin:0;">ログアウト</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </div>

    <div class="foot">※ 表示価格は税込です / 当店はテーブルチャージ 330円を頂いております</div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Bottom nav（✅ 1〜12だけ。管理ボタンは削除） -->
  <div id="bottomNav" class="bottomNav">
    <div class="tabs">
      <button id="tabOrder" class="tabBtn active">オーダー <span id="cartBadge" class="badge">0</span></button>
      <button id="tabHistory" class="tabBtn">注文履歴</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      doc, getDoc, setDoc,
      query, where, getDocs, writeBatch, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.firebasestorage.app",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ✅ テーブルは 1〜12
    const MAX_TABLE = 12;

    const CATEGORIES = [
      { id:"osusume",    label:"おすすめ" },
      { id:"ippin",      label:"一品料理" },
      { id:"youniku",    label:"羊肉" },
      { id:"yasai",      label:"野菜" },
      { id:"gohan",      label:"ご飯類" },
      { id:"alcohol",    label:"アルコール" },
      { id:"nihonshu",   label:"日本酒" },
      { id:"wine",       label:"ワイン" },
      { id:"nonal",      label:"ノンアルコール" },
      { id:"other",      label:"その他" },
    ];

    const MENU = [
      { id:"lamb_raw",          category:"youniku", name:"生ラム", desc:"", price:1188 },
      { id:"lamb_raw_jyo",      category:"youniku", name:"上生ラム", desc:"", price:1518 },
      { id:"lamb_momo_steak",   category:"youniku", name:"生ラムモモステーキ", desc:"", price:1188 },
      { id:"lamb_tan_gokujo",   category:"youniku", name:"極上ラムタン", desc:"", price:1408 },
      { id:"mutton_hire",       category:"youniku", name:"マトンヒレ", desc:"", price:1298 },
      { id:"lamb_sirloin",      category:"youniku", name:"生ラムサーロイン", desc:"", price:1958 },
      { id:"lamb_ham_salad",    category:"youniku", name:"羊の生ハムサラダ風", desc:"", price:1078 },
      { id:"lamb_wiener_1",     category:"youniku", name:"ラムウィンナー（1本）", desc:"", price:253 },
      { id:"lamb_chop_1",       category:"youniku", name:"骨付きラムチョップ（1本）", desc:"", price:1298, img:"images/lamb_chop.jpg" },
      { id:"aburi_nigiri_2",    category:"youniku", name:"炙り生ラムの握り（2貫）", desc:"", price:968 },

      { id:"yasai_moriawase",   category:"yasai", name:"野菜盛り合わせ", desc:"", price:748 },
      { id:"moyashi",           category:"yasai", name:"もやし", desc:"", price:418 },
      { id:"tamanegi",          category:"yasai", name:"玉ねぎ", desc:"", price:418 },
      { id:"naganegi",          category:"yasai", name:"長ネギ", desc:"", price:418 },
      { id:"kyabetsu",          category:"yasai", name:"キャベツ", desc:"", price:418 },
      { id:"ninniku_no_me",     category:"yasai", name:"ニンニクの芽", desc:"", price:418 },
      { id:"abura_add",         category:"yasai", name:"追加 脂代", desc:"（追加オプション）", price:110 },

      { id:"ume_kimchi",        category:"ippin", name:"さっぱり梅キムチ", desc:"", price:638 },
      { id:"kimchi_home",       category:"ippin", name:"ひつじやの手作りキムチ", desc:"", price:528 },
      { id:"kakuteki_home",     category:"ippin", name:"ひつじやの手作りカクテキ", desc:"", price:528 },
      { id:"moyashi_namul_std", category:"ippin", name:"もやしナムル スタンダード", desc:"", price:418 },
      { id:"moyashi_namul_hot", category:"ippin", name:"もやしナムル 辛口", desc:"", price:528 },
      { id:"kyuuri_zuke",       category:"ippin", name:"自家製きゅうり漬け", desc:"", price:528 },
      { id:"mozuku_su",         category:"ippin", name:"もずく酢", desc:"", price:528 },
      { id:"yamaimo_wasabi",    category:"ippin", name:"山芋山葵醤油漬け", desc:"", price:748 },
      { id:"tamago_soup",       category:"ippin", name:"卵スープ", desc:"", price:528 },
      { id:"wakame_soup",       category:"ippin", name:"わかめスープ", desc:"", price:528 },
      { id:"hitsujiya_reimen",  category:"ippin", name:"ひつじやの冷麺", desc:"", price:1078 },
      { id:"season_sherbet",    category:"ippin", name:"季節のシャーベット", desc:"", price:385 },

      { id:"koshihikari_m",     category:"gohan", name:"農家直送県内産コシヒカリ（中）", desc:"", price:308 },
      { id:"koshihikari_l",     category:"gohan", name:"農家直送県内産コシヒカリ（大）", desc:"", price:418 },
    ];

    const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");
    const fmtTime = (d) => {
      try{
        const dt = d instanceof Date ? d : new Date(d);
        return dt.toLocaleString("ja-JP", { month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      } catch { return ""; }
    };

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=> t.style.display = "none", 2200);
    }

    function newSessionId(){
      const r = Math.random().toString(36).slice(2,8);
      const t = Date.now().toString(36);
      return `s_${t}_${r}`;
    }

    // ✅ 新規通知用（簡易ビープ）
    function beep(){
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        const ctx = new Ctx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.06;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      } catch {}
    }

    // ===== URL params =====
    const qs = new URLSearchParams(location.search);
    const tableParam = qs.get("table");
    const table = Number(tableParam);
    const tableOk = Number.isFinite(table) && table > 0;

    // ✅ ルール：1〜12=お客, 708=スタッフ
    const isCustomerTable = tableOk && table >= 1 && table <= MAX_TABLE;
    const isAdminTable = tableOk && table === 708;

    const tablePill = document.getElementById("tablePill");
    const tableNoEl = document.getElementById("tableNo");
    if (tableOk) {
      tablePill.style.display = "inline-flex";
      tableNoEl.textContent = String(table);
    } else {
      toast("URLに ?table=1 のようにテーブル番号を付けてください");
    }

    // ===== Session pill（表示はしない） =====
    const sessionPill = document.getElementById("sessionPill");
    const sessionText = document.getElementById("sessionText");

    // ===== Drawer open/close =====
    const hamburger = document.getElementById("hamburger");
    const drawer = document.getElementById("drawer");
    const drawerOverlay = document.getElementById("drawerOverlay");
    const drawerClose = document.getElementById("drawerClose");
    function openDrawer(){
      drawer.classList.add("show");
      drawerOverlay.classList.add("show");
      drawer.setAttribute("aria-hidden", "false");
    }
    function closeDrawer(){
      drawer.classList.remove("show");
      drawerOverlay.classList.remove("show");
      drawer.setAttribute("aria-hidden", "true");
    }
    hamburger?.addEventListener("click", openDrawer);
    drawerClose?.addEventListener("click", closeDrawer);
    drawerOverlay?.addEventListener("click", closeDrawer);

    // ===== Views =====
    const viewOrder = document.getElementById("viewOrder");
    const viewHistory = document.getElementById("viewHistory");
    const viewAdmin = document.getElementById("viewAdmin");

    const tabOrder = document.getElementById("tabOrder");
    const tabHistory = document.getElementById("tabHistory");

    function setTab(which){
      if (tabOrder) tabOrder.classList.remove("active");
      if (tabHistory) tabHistory.classList.remove("active");

      for (const v of [viewOrder, viewHistory, viewAdmin]) v.classList.remove("active");

      if (which === "order"){
        tabOrder?.classList.add("active");
        viewOrder.classList.add("active");
      }
      if (which === "history"){
        tabHistory?.classList.add("active");
        viewHistory.classList.add("active");
        refreshHistory().catch(()=>{});
      }
      if (which === "admin"){
        viewAdmin.classList.add("active");
      }
    }

    // ✅ 下のオーダーボタン＝「カートへスクロール」
    function scrollToOrder(){
      const el = document.getElementById("order-content");
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    tabOrder?.addEventListener("click", () => {
      // すでにオーダー画面なら下へ
      if (viewOrder.classList.contains("active")) {
        scrollToOrder();
        return;
      }
      setTab("order");
      setTimeout(scrollToOrder, 80);
    });

    tabHistory?.addEventListener("click", () => setTab("history"));

    // ===== Cart =====
    const catNavEl = document.getElementById("catNav");
    const drawerNavEl = document.getElementById("drawerNav");
    const menuEl = document.getElementById("menu");
    const cartListEl = document.getElementById("cartList");
    const totalEl = document.getElementById("total");
    const orderBtn = document.getElementById("orderBtn");
    const cartBadge = document.getElementById("cartBadge");

    const CART_KEY = tableOk ? `cart_table_${table}` : "cart_table_unknown";
    let cart = {};
    try{
      const saved = localStorage.getItem(CART_KEY);
      if (saved) cart = JSON.parse(saved) || {};
    } catch {}

    function saveCart(){
      try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch {}
    }
    function cartItems(){
      return Object.values(cart).filter(x => x.qty > 0);
    }
    function cartQtyTotal(){
      return cartItems().reduce((sum, x) => sum + x.qty, 0);
    }
    function calcTotal(){
      return cartItems().reduce((sum, x) => sum + x.price * x.qty, 0);
    }
    function updateBadge(){
      if (cartBadge) cartBadge.textContent = String(cartQtyTotal());
    }

    // ===== Session / Stock state =====
    let currentSessionId = null;
    let stock = {}; // { [itemId]: { soldOut: boolean } }

    async function loadSessionForTable(t){
      const ref = doc(db, "table_state", `table_${t}`);
      const snap = await getDoc(ref);
      if (snap.exists()){
        const data = snap.data() || {};
        return String(data.sessionId || "");
      }
      return "";
    }

    async function loadSession(){
      if (!tableOk) return;

      // ✅ 表示は消す（お客にセッションを見せない）
      sessionPill.style.display = "none";

      // ✅ お客（1〜12）は table_state の sessionId を使う
      if (isCustomerTable){
        currentSessionId = await loadSessionForTable(table);
        if (currentSessionId){
          const tail = currentSessionId.length > 14 ? "…" + currentSessionId.slice(-12) : currentSessionId;
          sessionText.textContent = tail;
        } else {
          sessionText.textContent = "未設定";
          toast("セッション未設定です（スタッフが会計/開始してください）");
        }
        return;
      }

      // ✅ 708はセッション表示だけ（任意）
      if (isAdminTable){
        sessionText.textContent = "管理";
      }
    }

    async function loadStock(){
      stock = {};
      try{
        const snaps = await getDocs(query(collection(db, "stock")));
        snaps.forEach(s => { stock[s.id] = s.data() || {}; });
      } catch {
        // 読めなくても動作は続行
      }
    }

    function goCategory(catId){
      const el = document.getElementById(`cat-${catId}`);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      closeDrawer();
    }

    function renderNavInto(container){
      if (!container) return;
      const counts = new Map();
      for (const c of CATEGORIES) counts.set(c.id, MENU.filter(m => m.category === c.id).length);
      const orderCount = cartQtyTotal();

      container.innerHTML = [
        `<a class="navBtn" data-nav="order" href="#order-content">
          <span>注文</span><small>${orderCount}</small>
        </a>`,
        ...CATEGORIES.map(c => {
          const count = counts.get(c.id) ?? 0;
          return `<a class="navBtn" data-nav="${c.id}" href="#cat-${c.id}">
                    <span>${c.label}</span><small>${count}</small>
                  </a>`;
        })
      ].join("");

      container.querySelectorAll("a.navBtn").forEach(a => {
        a.addEventListener("click", (e) => {
          const key = a.getAttribute("data-nav");
          if (!key) return;
          e.preventDefault();
          if (key === "order") scrollToOrder();
          else goCategory(key);
        });
      });
    }

    function renderNav(){
      renderNavInto(catNavEl);
      renderNavInto(drawerNavEl);
    }

    const addQty = {}; // { [itemId]: number }
    function getAddQty(id){
      const v = Number(addQty[id] ?? 1);
      return Math.max(1, Math.min(10, v));
    }
    function setAddQty(id, v){
      addQty[id] = Math.max(1, Math.min(10, Number(v) || 1));
    }

    function renderMenu(){
      const byCat = new Map();
      for (const c of CATEGORIES) byCat.set(c.id, []);
      for (const m of MENU) {
        if (!byCat.has(m.category)) byCat.set(m.category, []);
        byCat.get(m.category).push(m);
      }

      menuEl.innerHTML = CATEGORIES.map(c => {
        const items = byCat.get(c.id) || [];
        const grid = items.map(m => {
          const isSold = !!(stock?.[m.id]?.soldOut);
          const qty = getAddQty(m.id);

          const imgHtml = m.img ? `
            <div class="imgBox">
              <img src="${m.img}" alt="${m.name}">
            </div>
          ` : `<div class="imgBox" aria-hidden="true"></div>`;

          return `
            <div class="itemCard" data-item="${m.id}">
              ${isSold ? `<div class="soldOverlay"></div><div class="soldBadge">品切れ</div>` : ``}
              ${imgHtml}

              <div style="min-width:0;">
                <h3>${m.name}</h3>
                <p class="desc">${m.desc || ""}</p>
                <p class="price">${yen(m.price)}</p>
              </div>

              <div class="stepRow">
                <div class="stepper" aria-label="数量">
                  <button class="stepBtn" data-step-minus="${m.id}" ${isSold ? "disabled" : ""}>−</button>
                  <div class="stepQty" data-step-qty="${m.id}">${qty}</div>
                  <button class="stepBtn" data-step-plus="${m.id}" ${isSold ? "disabled" : ""}>＋</button>
                </div>
                <button class="addBtn" data-add="${m.id}" ${isSold ? "disabled" : ""}>カートに追加</button>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="section" id="cat-${c.id}">
            <div class="sectionHead">
              <h2>${c.label}</h2>
              <p>${items.length} 品</p>
            </div>
            <div class="menuGrid">
              ${grid || `<div style="color:var(--muted);padding:6px 10px;">（準備中）</div>`}
            </div>
          </div>
        `;
      }).join("");
    }

    function renderCart(){
      const items = cartItems();
      if (!items.length){
        cartListEl.innerHTML = `<li style="color:var(--muted);padding:6px 2px;">（まだ商品が選ばれていません）</li>`;
      } else {
        cartListEl.innerHTML = items.map(x => `
          <li class="cartRow" data-id="${x.id}">
            <div style="min-width:0;">
              <div class="cartName">${x.name}</div>
              <div class="cartMeta">${yen(x.price)} / 1点</div>
            </div>
            <div class="qtyBox">
              <button class="qtyBtn" data-minus="${x.id}">−</button>
              <div class="qty">${x.qty}</div>
              <button class="qtyBtn" data-plus="${x.id}">＋</button>
            </div>
          </li>
        `).join("");
      }

      const total = calcTotal();
      totalEl.textContent = yen(total);

      // ✅ お客だけ注文可能
      orderBtn.disabled = !isCustomerTable || !currentSessionId || total === 0;

      renderNav();
      updateBadge();
    }

    function addItem(id, qty){
      const m = MENU.find(x => x.id === id);
      if (!m) return;
      if (stock?.[id]?.soldOut) { toast("品切れです"); return; }

      const n = Math.max(1, Math.min(10, Number(qty) || 1));
      if (!cart[id]) cart[id] = { id:m.id, name:m.name, price:m.price, qty:0 };
      cart[id].qty += n;

      saveCart();
      renderCart();
      toast(`${m.name} を +${n} 追加しました`);
    }

    function changeQty(id, delta){
      if (!cart[id]) return;
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      saveCart();
      renderCart();
    }

    menuEl.addEventListener("click", (e) => {
      const btnAdd = e.target.closest("[data-add]");
      const btnMinus = e.target.closest("[data-step-minus]");
      const btnPlus  = e.target.closest("[data-step-plus]");

      if (btnMinus){
        const id = btnMinus.getAttribute("data-step-minus");
        setAddQty(id, getAddQty(id) - 1);
        const qEl = menuEl.querySelector(`[data-step-qty="${CSS.escape(id)}"]`);
        if (qEl) qEl.textContent = String(getAddQty(id));
        return;
      }
      if (btnPlus){
        const id = btnPlus.getAttribute("data-step-plus");
        setAddQty(id, getAddQty(id) + 1);
        const qEl = menuEl.querySelector(`[data-step-qty="${CSS.escape(id)}"]`);
        if (qEl) qEl.textContent = String(getAddQty(id));
        return;
      }
      if (btnAdd){
        const id = btnAdd.getAttribute("data-add");
        addItem(id, getAddQty(id));
        return;
      }
    });

    cartListEl.addEventListener("click", (e) => {
      const minus = e.target.closest("[data-minus]");
      const plus  = e.target.closest("[data-plus]");
      if (minus) changeQty(minus.dataset.minus, -1);
      if (plus)  changeQty(plus.dataset.plus, +1);
    });

    // ===== 注文送信（✅ orders + public_orders の両方に保存） =====
    orderBtn.addEventListener("click", async () => {
      if (!isCustomerTable) { toast("このテーブルでは注文できません"); return; }
      if (!currentSessionId) { toast("セッション未設定です（スタッフが開始/会計）"); return; }

      const items = cartItems();
      const total = calcTotal();
      if (!items.length || total <= 0) { toast("商品を選んでください"); return; }

      orderBtn.disabled = true;
      const oldText = orderBtn.textContent;
      orderBtn.textContent = "送信中…";

      try{
        const payload = {
          table: table,
          sessionId: currentSessionId,
          items: items.map(x => ({ name: x.name, qty: x.qty, price: x.price })),
          total: total,
          status: "new",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        // 1) スタッフ用（管理）に表示される orders
        await addDoc(collection(db, "orders"), payload);

        // 2) お客用履歴 public_orders（read 可能）
        await addDoc(collection(db, "public_orders"), {
          table: table,
          sessionId: currentSessionId,
          items: payload.items,
          total: total,
          status: "new",
          createdAt: serverTimestamp()
        });

        cart = {};
        saveCart();
        renderCart();
        toast("ありがとうございます！注文を送信しました。");
      } catch(err){
        console.error(err);
        toast("送信に失敗しました（Firestoreルール/設定を確認）");
      } finally {
        orderBtn.textContent = oldText;
        orderBtn.disabled = !isCustomerTable || !currentSessionId || calcTotal() === 0;
      }
    });

    // ===== 注文履歴（public_orders） =====
    const historyList = document.getElementById("historyList");

    function renderHistoryRows(rows){
      if (!rows.length){
        historyList.innerHTML = `<li class="simpleRow"><div class="rowMeta">（このセッションの注文履歴はまだありません）</div></li>`;
        return;
      }
      historyList.innerHTML = rows.map(r => {
        const items = (r.items || []).map(it => `${it.name} ×${it.qty}`).join(" / ");
        return `
          <li class="simpleRow">
            <div class="rowTop">
              <div class="rowTitle">${yen(r.total || 0)}</div>
              <div class="rowMeta">${fmtTime(r._createdAt)}</div>
            </div>
            <div class="mini">${items}</div>
            <div class="rowMeta" style="margin-top:8px;">ステータス: ${r.status || "-"}</div>
          </li>
        `;
      }).join("");
    }

    async function refreshHistory(){
      if (!isCustomerTable || !currentSessionId){
        renderHistoryRows([]);
        return;
      }
      try{
        const qy = query(
          collection(db, "public_orders"),
          where("table", "==", table),
          where("sessionId", "==", currentSessionId)
        );
        const snaps = await getDocs(qy);
        const rows = [];
        snaps.forEach(s => {
          const d = s.data() || {};
          let created = null;
          try{ created = d.createdAt?.toDate?.() || null; } catch {}
          rows.push({ id: s.id, ...d, _createdAt: created || new Date(0) });
        });
        rows.sort((a,b)=> (b._createdAt?.getTime?.()||0) - (a._createdAt?.getTime?.()||0));
        renderHistoryRows(rows.filter(x => x.status !== "cleared"));
      } catch (err){
        console.error(err);
        historyList.innerHTML = `<li class="simpleRow"><div class="rowMeta">履歴を取得できません（public_orders の read / ルール / インデックス確認）</div></li>`;
      }
    }

    // ===== Admin auth & actions (708) =====
    const adminStatus = document.getElementById("adminStatus");
    const adminActions = document.getElementById("adminActions");
    const logoutBtn = document.getElementById("logoutBtn");
    const stockList = document.getElementById("stockList");
    const resetList = document.getElementById("resetList");

    // ゲート
    const adminGate = document.getElementById("adminGate");
    const gateEmail = document.getElementById("gateEmail");
    const gatePass = document.getElementById("gatePass");
    const gateLoginBtn = document.getElementById("gateLoginBtn");
    const gateMsg = document.getElementById("gateMsg");

    function showGate(msg=""){
      if (!adminGate) return;
      adminGate.classList.add("show");
      adminGate.setAttribute("aria-hidden", "false");
      if (gateMsg) gateMsg.textContent = msg;
    }
    function hideGate(){
      if (!adminGate) return;
      adminGate.classList.remove("show");
      adminGate.setAttribute("aria-hidden", "true");
      if (gateMsg) gateMsg.textContent = "";
    }

    function setAdminUI(user){
      if (!isAdminTable) return;
      if (user){
        adminStatus.textContent = `ログイン中: ${user.email || ""}`;
        adminActions.style.display = "block";
        hideGate();
      } else {
        adminStatus.textContent = "未ログイン";
        adminActions.style.display = "none";
        showGate("ログインしてください。");
      }
    }

    gateLoginBtn?.addEventListener("click", async () => {
      const email = (gateEmail?.value || "").trim();
      const pass = (gatePass?.value || "");
      if (!email || !pass){
        showGate("メールアドレスとパスワードは必須です。");
        return;
      }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("ログインしました");
      } catch (e){
        console.error(e);
        showGate("ログイン失敗（メール/パスワード/ルール確認）");
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      try{ await signOut(auth); toast("ログアウトしました"); } catch {}
    });

    // ===== 708：品切れON/OFF =====
    async function renderStockAdmin(){
      if (!isAdminTable) return;
      stockList.innerHTML = "";
      const items = MENU.map(m => ({ id:m.id, name:m.name }));
      for (const it of items){
        const sold = !!(stock?.[it.id]?.soldOut);
        const row = document.createElement("div");
        row.className = "toggleRow";
        row.innerHTML = `
          <div style="min-width:0;">
            <strong>${it.name}</strong>
            <div class="rowMeta">ID: ${it.id}</div>
          </div>
          <div class="sw ${sold ? "on" : ""}" data-sw="${it.id}" title="品切れ"></div>
        `;
        stockList.appendChild(row);
      }

      stockList.querySelectorAll("[data-sw]").forEach(el => {
        el.addEventListener("click", async () => {
          const id = el.getAttribute("data-sw");
          const now = !!(stock?.[id]?.soldOut);
          const next = !now;

          try{
            const ref = doc(db, "stock", id);
            await setDoc(ref, { soldOut: next, updatedAt: serverTimestamp() }, { merge: true });
            stock[id] = { ...(stock[id] || {}), soldOut: next };
            el.classList.toggle("on", next);

            renderMenu(); // お客側UIに即反映（同ページで見てる場合）
            toast(next ? "品切れにしました" : "販売再開しました");
          } catch (e){
            console.error(e);
            toast("品切れ更新に失敗（stock の write ルール/管理者判定）");
          }
        });
      });
    }

    // ===== 708：テーブル別 会計＆履歴無効化（1〜12） =====
    async function resetTable(t){
      // 1) 現在のsessionIdを取得
      const oldSid = await loadSessionForTable(t);

      // 2) 新しいsessionIdを発行して table_state 更新
      const newSid = newSessionId();
      const stRef = doc(db, "table_state", `table_${t}`);
      await setDoc(stRef, { table: t, sessionId: newSid, updatedAt: serverTimestamp() }, { merge:true });

      // 3) 直前セッションの orders を cleared
      if (oldSid){
        const snaps1 = await getDocs(query(
          collection(db, "orders"),
          where("table", "==", t),
          where("sessionId", "==", oldSid)
        ));
        const batch1 = writeBatch(db);
        snaps1.forEach(s => batch1.update(s.ref, { status:"cleared", updatedAt: serverTimestamp() }));
        await batch1.commit();

        // 4) 直前セッションの public_orders も cleared（お客履歴から消す）
        const snaps2 = await getDocs(query(
          collection(db, "public_orders"),
          where("table", "==", t),
          where("sessionId", "==", oldSid)
        ));
        const batch2 = writeBatch(db);
        snaps2.forEach(s => batch2.update(s.ref, { status:"cleared" }));
        await batch2.commit();
      }

      // ✅ 会計イベントを orders に記録（708で気づけるようにする）
      await addDoc(collection(db, "orders"), {
        table: t,
        sessionId: oldSid || "",
        items: [],
        total: 0,
        status: "cashout",
        note: "会計",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }

    async function renderTableResetList(){
      if (!isAdminTable) return;
      resetList.innerHTML = "";
      for (let t=1; t<=MAX_TABLE; t++){
        const btn = document.createElement("button");
        btn.className = "orderBtn";
        btn.style.boxShadow = "none";
        btn.style.marginTop = "0";
        btn.textContent = `テーブル ${t} 会計＆履歴無効化`;
        btn.addEventListener("click", async () => {
          const ok = confirm(`テーブル${t}を会計します。直前セッションの履歴を無効化します。続行？`);
          if (!ok) return;
          try{
            btn.disabled = true;
            const old = btn.textContent;
            btn.textContent = "処理中…";
            await resetTable(t);
            toast(`テーブル${t}を会計しました`);
            btn.textContent = old;
          } catch(e){
            console.error(e);
            toast("会計に失敗（table_state / orders / public_orders の権限確認）");
          } finally{
            btn.disabled = false;
          }
        });
        resetList.appendChild(btn);
      }
    }

    // ===== 708：注文管理（未完了/完了/一覧） =====
    const adminTabNew = document.getElementById("adminTabNew");
    const adminTabDone = document.getElementById("adminTabDone");
    const adminTabAll = document.getElementById("adminTabAll");
    const cntNew = document.getElementById("cntNew");
    const cntDone = document.getElementById("cntDone");
    const cntAll = document.getElementById("cntAll");
    const adminOrdersList = document.getElementById("adminOrdersList");

    let adminFilter = "new"; // "new" | "done" | "all"
    let adminOrdersCache = [];

    function setAdminFilter(f){
      adminFilter = f;
      adminTabNew?.classList.toggle("active", f==="new");
      adminTabDone?.classList.toggle("active", f==="done");
      adminTabAll?.classList.toggle("active", f==="all");
      renderAdminOrdersFromCache();
    }

    adminTabNew?.addEventListener("click", ()=> setAdminFilter("new"));
    adminTabDone?.addEventListener("click", ()=> setAdminFilter("done"));
    adminTabAll?.addEventListener("click", ()=> setAdminFilter("all"));

    function statusLabel(s){
      if (s === "done") return "完了";
      if (s === "canceled") return "取消";
      if (s === "cashout") return "会計";
      return "未完了";
    }

    function formatOrderTitle(r){
      const when = fmtTime(r._createdAt);
      if (r.status === "cashout") return `テーブル ${r.table} お会計（${when}）`;
      return `テーブル ${r.table} が注文されました（${when}）`;
    }

    function renderAdminOrdersFromCache(){
      const rowsAll = adminOrdersCache.filter(x => x.status !== "cleared");
      const rowsNew = rowsAll.filter(x => (x.status || "new") === "new" || x.status === "cashout");
      const rowsDone = rowsAll.filter(x => x.status === "done");

      cntAll.textContent = String(rowsAll.length);
      cntNew.textContent = String(rowsNew.length);
      cntDone.textContent = String(rowsDone.length);

      let show = rowsAll;
      if (adminFilter === "new") show = rowsNew;
      if (adminFilter === "done") show = rowsDone;

      if (!show.length){
        adminOrdersList.innerHTML = `<li class="simpleRow"><div class="rowMeta">（表示する注文がありません）</div></li>`;
        return;
      }

      adminOrdersList.innerHTML = show.map(r => {
        const items = (r.items || []).map(it => `${it.name} ×${it.qty}`).join(" / ");
        const st = statusLabel(r.status || "new");

        const detail = r.status === "cashout"
          ? `<div class="mini">会計通知です（注文ではありません）</div>`
          : `<div class="mini">合計: ${yen(r.total || 0)}<br>${items}</div>`;

        return `
          <li class="simpleRow" data-oid="${r.id}">
            <div class="rowTop">
              <div class="rowTitle">${formatOrderTitle(r)}</div>
              <div class="rowMeta">${st}</div>
            </div>
            ${detail}

            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="ghostBtn" style="margin:0; flex:1;" data-set="done">完了</button>
              <button class="ghostBtn" style="margin:0; flex:1; border-color:rgba(164,0,0,.35);" data-set="canceled">取消</button>
              <button class="ghostBtn" style="margin:0; flex:1;" data-set="new">未完了</button>
            </div>
          </li>
        `;
      }).join("");
    }

    // ✅ 708：リアルタイム監視（in は最大10件 → 1..10 / 11..12 の2本）
    let lastSeenNewCount = 0;
    let snapRowsA = [];
    let snapRowsB = [];
    let unsubA = null;
    let unsubB = null;

    function mergeAndRenderFromSnapshots(){
      const rows = [...snapRowsA, ...snapRowsB];
      rows.sort((a,b)=> (b._createdAt?.getTime?.()||0) - (a._createdAt?.getTime?.()||0));
      adminOrdersCache = rows;

      // new + cashout を「未完了」として通知対象に
      const rowsAll = adminOrdersCache.filter(x => x.status !== "cleared");
      const rowsNew = rowsAll.filter(x => (x.status || "new") === "new" || x.status === "cashout");

      if (rowsNew.length > lastSeenNewCount){
        beep();
        try{ navigator.vibrate?.(200); } catch {}
        toast("新しい通知があります");
        document.title = `(${rowsNew.length}) ひつじや 管理`;
        setTimeout(()=> { document.title = "ひつじや 管理"; }, 1800);
      }
      lastSeenNewCount = rowsNew.length;

      renderAdminOrdersFromCache();
    }

    function startAdminRealtime(){
      if (!isAdminTable) return;
      // 既存unsubscribe
      try{ unsubA?.(); } catch {}
      try{ unsubB?.(); } catch {}
      unsubA = null; unsubB = null;

      const tablesA = Array.from({length: 10}, (_,i)=> i+1); // 1..10
      const tablesB = [11, 12];

      const qA = query(collection(db, "orders"), where("table", "in", tablesA));
      const qB = query(collection(db, "orders"), where("table", "in", tablesB));

      unsubA = onSnapshot(qA, (snaps)=>{
        snapRowsA = [];
        snaps.forEach(s => {
          const d = s.data() || {};
          let created = null;
          try{ created = d.createdAt?.toDate?.() || null; } catch {}
          snapRowsA.push({ id: s.id, ...d, _createdAt: created || new Date(0) });
        });
        mergeAndRenderFromSnapshots();
      });

      unsubB = onSnapshot(qB, (snaps)=>{
        snapRowsB = [];
        snaps.forEach(s => {
          const d = s.data() || {};
          let created = null;
          try{ created = d.createdAt?.toDate?.() || null; } catch {}
          snapRowsB.push({ id: s.id, ...d, _createdAt: created || new Date(0) });
        });
        mergeAndRenderFromSnapshots();
      });
    }

    adminOrdersList.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-set]");
      if (!btn) return;

      const li = e.target.closest("[data-oid]");
      if (!li) return;
      const oid = li.getAttribute("data-oid");
      const next = btn.getAttribute("data-set");

      try{
        const ref = doc(db, "orders", oid);
        await setDoc(ref, { status: next, updatedAt: serverTimestamp() }, { merge:true });
        toast("更新しました");
        // リアルタイム監視が勝手に反映するので refresh は不要
      } catch(err){
        console.error(err);
        toast("更新失敗（orders update ルール/管理者判定）");
      }
    });

    // ===== 初期表示の分岐 =====
    const bottomNav = document.getElementById("bottomNav");

    // 708はスタッフ画面だけにして、下ナビも消す
    if (isAdminTable){
      if (bottomNav) bottomNav.style.display = "none";
      setTab("admin");
      // 708はカテゴリ/メニュー要らないのでハンバーガーも隠す
      if (hamburger) hamburger.style.display = "none";
    } else {
      // お客画面（1〜12）
      setTab("order");
    }

    // ===== Auth監視（708は未ログインならゲート強制） =====
    onAuthStateChanged(auth, async (user) => {
      setAdminUI(user);

      if (user && isAdminTable){
        await loadStock();
        await renderStockAdmin();
        await renderTableResetList();
        startAdminRealtime(); // ✅ これで “ずっと凝視しなくても” 気づける
      } else {
        // ログアウト時は監視停止
        try{ unsubA?.(); } catch {}
        try{ unsubB?.(); } catch {}
        unsubA = null; unsubB = null;
      }
    });

    // ===== 初期描画（お客側） =====
    renderNav();

    await loadStock();
    renderMenu();

    await loadSession();
    renderCart();

    // 1〜12以外は（例えば708を除く変な番号）案内だけ
    if (!isCustomerTable && !isAdminTable && tableOk){
      toast("このテーブル番号は無効です（1〜12、または708）");
    }
  </script>
</body>
</html>
