<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>北海道本格ジンギスカン ひつじや｜ご注文</title>

  <style>
    :root{
      --bg:#0b0d10;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.58);
      --gold:#c8a45a;
      --danger:#a40000;
      --danger2:#7c0000;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;

      --pad-desktop: 26px;
      --pad-mobile: 14px;

      /* ① タイトル：スマホで1行に収める */
      --title-desktop: 30px;
      --title-mobile: 22px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(200,164,90,.12), transparent 70%),
                  radial-gradient(900px 500px at 90% 0%, rgba(200,164,90,.08), transparent 70%),
                  var(--bg);
      color:var(--text);
      font-size: 16px;
      overflow-x: hidden;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:var(--pad-desktop) 16px 84px; }

    header{
      padding:10px 0 18px;
      border-bottom: 1px solid var(--line);
      margin-bottom:18px;
      position: relative;
    }

    .title{
      font-size:var(--title-desktop);
      font-weight:1000;
      letter-spacing:.02em;
      color:var(--gold);
      margin:0 0 6px;
      line-height:1.15;
    }

    .sub{
      margin:0;
      color:var(--muted);
      font-size:15px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:13px;
      margin-top:10px;
    }
    .pill strong{ color:var(--text); }

    /* タイトル左右にひつじ */
    .title-with-sheep{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title-text{
      text-align:center;
      word-break: keep-all;
      line-break: strict;
    }
    .sheep-icon{
      width:34px;
      height:34px;
      flex:0 0 auto;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.45));
    }

    /* ① スマホで1行固定：アイコン消して、nowrap */
    @media (max-width: 520px){
      .title-with-sheep{ flex-wrap:nowrap; gap:8px; }
      .sheep-icon{ display:none; }
      .title-text{
        white-space:nowrap;
        font-size: var(--title-mobile);
        letter-spacing: .01em;
      }
      .title{ font-size: var(--title-mobile); }
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .layout{ grid-template-columns: 240px 1fr 360px; align-items:start; }
    }

    /* Left category nav (PC) */
    .navCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: sticky;
      top: 14px;
    }
    .navTitle{
      padding:14px 14px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
      font-size:15px;
    }
    .navList{ display:flex; flex-direction:column; gap:8px; padding:12px; }
    .navBtn{
      display:flex; justify-content:space-between; align-items:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding:11px 12px;
      border-radius:14px;
      text-decoration:none;
      font-weight:900;
      transition:.15s;
      cursor: pointer;
      font-size:15px;
    }
    .navBtn:hover{ background: rgba(200,164,90,.10); border-color: rgba(200,164,90,.35); }
    .navBtn small{ color:var(--muted); font-weight:900; font-size:13px; }

    @media (max-width: 979px){
      .navCard{ display:none; }
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelTitle{
      padding:14px 16px;
      font-weight:1000;
      color:var(--gold);
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.18);
      letter-spacing:.04em;
      font-size:15px;
    }

    /* Menu area */
    .menuWrap{ padding:14px; }
    .section{ margin: 8px 0 18px; scroll-margin-top: 80px; }
    .sectionHead{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px;
      padding:10px 10px 12px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .sectionHead h2{
      margin:0;
      font-size:19px;
      font-weight:1000;
      letter-spacing:.03em;
      color: var(--text);
    }
    .sectionHead p{ margin:0; font-size:13px; color: var(--muted); font-weight:900; }

    /* 商品は常に2列 */
    .menuGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .itemCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:240px;
      position: relative;
    }

    /* ② 商品画像 */
    .itemImg{
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .itemImg img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .itemImg.ph{
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.35);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.08em;
    }

    .itemCard h3{
      margin:0 0 4px;
      font-size:16px;
      font-weight:1000;
      letter-spacing:.02em;
      line-height:1.2;
    }
    .desc{
      margin:0 0 6px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      font-weight:700;
      min-height: 18px;
    }
    .price{
      margin:0;
      font-size:18px;
      font-weight:1000;
      color:var(--gold);
    }

    /* ④ 右下カート追加 + 上にステッパー */
    .addArea{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }

    .stepper{
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .stepBtn{
      width:44px; height:44px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      font-size: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stepBtn:disabled{
      opacity:.35;
      cursor:not-allowed;
    }
    .stepQty{
      min-width: 28px;
      text-align:center;
      font-weight:1000;
      font-size: 18px;
    }

    .addBtn2{
      width:100%;
      border:1px solid rgba(200,164,90,.65);
      background: rgba(200,164,90,.12);
      color: var(--gold);
      padding:14px 12px;
      border-radius: 14px;
      font-weight:1000;
      cursor:pointer;
      transition: .15s;
      white-space:nowrap;
      font-size:16px;
    }
    .addBtn2:hover{ background: rgba(200,164,90,.18); }
    .addBtn2:active{ transform: translateY(1px); }
    .addBtn2:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .soldOutBadge{
      position:absolute;
      top:12px;
      right:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.9);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.06em;
      z-index: 2;
    }

    /* Right column stack */
    .rightCol{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* Cart */
    .cartBody{ padding:14px 16px 16px; position: sticky; top: 14px; }
    @media (max-width: 979px){
      .cartBody{ position: static; }
    }

    .cartList{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .cartRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.20);
    }
    .cartName{ font-weight:1000; font-size:16px; line-height:1.25; }
    .cartMeta{ color:var(--muted); font-size:13px; margin-top:2px; font-weight:800; }

    .qtyBox{ display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .qtyBtn{
      width:40px; height:40px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      font-size: 20px;
    }
    .qtyBtn:hover{ background: rgba(255,255,255,.06); }
    .qty{
      min-width: 26px;
      text-align:center;
      font-weight:1000;
      font-size: 18px;
    }

    .sumRow{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-weight:1000;
      font-size: 15px;
    }
    .sumVal{ color:var(--gold); font-size:24px; font-weight:1000; }

    .orderBtn{
      margin-top:12px;
      width:100%;
      border:0;
      background: linear-gradient(180deg, var(--danger), var(--danger2));
      color:#fff;
      font-weight:1000;
      letter-spacing:.08em;
      padding:16px 14px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(164,0,0,.35);
      transition:.15s;
      font-size:16px;
    }
    .orderBtn:hover{ filter: brightness(1.03); }
    .orderBtn:active{ transform: translateY(1px); }
    .orderBtn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    /* History */
    .historyBody{ padding: 12px 14px 14px; }
    .historyList{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
    .historyCard{
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      padding: 10px 10px;
    }
    .historyTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .historyTime{ color: rgba(255,255,255,.85); font-weight:1000; font-size: 13px; }
    .historyTotal{ color: var(--gold); font-weight:1000; font-size: 14px; }
    .historyItems{ color: var(--muted); font-size: 13px; font-weight:800; line-height:1.35; white-space: pre-wrap; }
    .tinyBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:1000;
      cursor:pointer;
      font-size: 13px;
    }
    .dangerBtn{
      border:1px solid rgba(164,0,0,.65);
      background: rgba(164,0,0,.20);
      color: rgba(255,255,255,.95);
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .foot{ margin-top:18px; text-align:center; color:rgba(255,255,255,.45); font-size:12px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(16,19,24,.92);
      border:1px solid var(--line);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-weight:900;
      display:none;
      max-width:min(560px, 92vw);
      z-index:9999;
      font-size:14px;
    }

    /* ===== Mobile drawer (hamburger) ===== */
    .hamburger{
      display:none;
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 1002;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      gap: 3px;
      flex-direction: column;
    }
    .hamburger span{
      width: 18px;
      height: 2px;
      background: rgba(255,255,255,.85);
      border-radius: 2px;
      display:block;
    }

    .drawerOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .drawerOverlay.show{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      left: 0;
      height: 100dvh;
      width: min(320px, 86vw);
      z-index: 1001;
      transform: translateX(-102%);
      transition: transform .18s ease;
      padding: 14px;
      background: rgba(10,12,16,.92);
      backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow:auto;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 6px 4px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .drawerTitle{
      font-weight: 1000;
      color: var(--gold);
      letter-spacing: .04em;
      font-size:15px;
    }
    .drawerClose{
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.9);
      font-size: 18px;
      cursor: pointer;
    }

    /* ② ありがとうございますモーダル */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10010;
      padding: 18px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(520px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(16,19,24,.96);
      box-shadow: var(--shadow);
      padding: 18px 16px 16px;
    }
    .modalTitle{
      font-size: 18px;
      font-weight:1000;
      color: var(--gold);
      margin:0 0 8px;
      letter-spacing:.04em;
    }
    .modalText{
      margin:0 0 14px;
      color: rgba(255,255,255,.88);
      font-weight:800;
      line-height:1.45;
      font-size:15px;
      white-space: pre-wrap;
    }
    .modalBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 12px 12px;
      border-radius: 14px;
      font-weight:1000;
      cursor:pointer;
      font-size:15px;
    }

    /* ③ 管理（品切れ）パネル */
    .adminPanel{
      margin-top:16px;
      padding: 14px;
    }
    .adminNote{
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      margin: 0 0 12px;
      line-height: 1.4;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      margin-bottom: 8px;
    }
    .toggleRow strong{
      font-weight:1000;
      font-size: 14px;
    }
    .toggleRow label{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      color: rgba(255,255,255,.9);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
    }
    .toggleRow input{
      width: 18px;
      height: 18px;
      accent-color: #c8a45a;
      cursor:pointer;
    }

    /* Mobile bottom quick tabs (見た目だけ雰囲気寄せ) */
    .bottomTabs{
      display:none;
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      z-index: 1003;
      background: rgba(10,12,16,.86);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 8px 10px;
      gap: 8px;
    }
    .tabBtn{
      flex: 1;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.9);
      border-radius: 14px;
      padding: 10px 8px;
      font-weight: 1000;
      cursor:pointer;
      font-size: 13px;
    }
    .tabBtn.active{
      border-color: rgba(200,164,90,.35);
      background: rgba(200,164,90,.12);
      color: var(--gold);
    }

    @media (max-width: 979px){
      .wrap{ padding: var(--pad-mobile) 12px 96px; }
      header{ padding: 8px 0 14px; margin-bottom: 14px; }
      .menuWrap{ padding: 12px; }
      .panelTitle{ padding: 12px 14px; }
      .cartBody{ padding: 12px 14px 14px; }
      .card{ box-shadow: 0 10px 30px rgba(0,0,0,.45); }
      .hamburger{ display:flex; }
      .bottomTabs{ display:flex; }
    }
  </style>
</head>

<body>
  <!-- スマホ用ハンバーガー＆ドロワー -->
  <button id="hamburger" class="hamburger" aria-label="カテゴリを開く">
    <span></span><span></span><span></span>
  </button>
  <div id="drawerOverlay" class="drawerOverlay"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawerHead">
      <div class="drawerTitle">メニュー</div>
      <button id="drawerClose" class="drawerClose" aria-label="閉じる">×</button>
    </div>
    <div id="drawerNav" class="navList"></div>
  </aside>

  <div class="wrap">
    <header id="top">
      <h1 class="title title-with-sheep">
        <span class="sheep-icon" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <g fill="none" stroke="none">
              <ellipse cx="30" cy="34" rx="18" ry="14" fill="#f5f5f5"/>
              <circle cx="18" cy="30" r="6" fill="#f5f5f5"/>
              <circle cx="42" cy="30" r="6" fill="#f5f5f5"/>
              <ellipse cx="44" cy="38" rx="9" ry="8" fill="#3b2f2a"/>
              <circle cx="41" cy="35" r="1.5" fill="#fff"/>
              <circle cx="47" cy="35" r="1.5" fill="#fff"/>
              <circle cx="41" cy="35" r="0.7" fill="#000"/>
              <circle cx="47" cy="35" r="0.7" fill="#000"/>
              <path d="M43 40c2 2 4 2 6 0" stroke="#000" stroke-width="1.3" stroke-linecap="round"/>
              <path d="M38 31c-3-6 3-10 6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <path d="M50 31c3-6-3-10-6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <rect x="22" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
              <rect x="33" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
            </g>
          </svg>
        </span>

        <span class="title-text">北海道本格ジンギスカン　ひつじや</span>

        <span class="sheep-icon" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(64,0) scale(-1,1)">
              <ellipse cx="30" cy="34" rx="18" ry="14" fill="#f5f5f5"/>
              <circle cx="18" cy="30" r="6" fill="#f5f5f5"/>
              <circle cx="42" cy="30" r="6" fill="#f5f5f5"/>
              <ellipse cx="44" cy="38" rx="9" ry="8" fill="#3b2f2a"/>
              <circle cx="41" cy="35" r="1.5" fill="#fff"/>
              <circle cx="47" cy="35" r="1.5" fill="#fff"/>
              <circle cx="41" cy="35" r="0.7" fill="#000"/>
              <circle cx="47" cy="35" r="0.7" fill="#000"/>
              <path d="M43 40c2 2 4 2 6 0" stroke="#000" stroke-width="1.3" stroke-linecap="round"/>
              <path d="M38 31c-3-6 3-10 6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <path d="M50 31c3-6-3-10-6-7" stroke="#3b2f2a" stroke-width="3" stroke-linecap="round"/>
              <rect x="22" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
              <rect x="33" y="45" width="5" height="9" rx="2.5" fill="#3b2f2a"/>
            </g>
          </svg>
        </span>
      </h1>

      <p class="sub">ごゆっくりお選びください</p>

      <div id="tablePill" class="pill" style="display:none;">
        テーブル <strong id="tableNo">-</strong>
      </div>

      <div id="sessionPill" class="pill" style="display:none;">
        セッション <strong id="sessionShort">-</strong>
      </div>
    </header>

    <div class="layout">
      <!-- 左：カテゴリ（PC用） -->
      <aside class="navCard">
        <div class="navTitle">カテゴリ</div>
        <div id="catNav" class="navList"></div>
      </aside>

      <!-- 中：メニュー -->
      <section class="card" id="menu-content">
        <div class="panelTitle">メニュー</div>
        <div class="menuWrap" id="menu"></div>

        <!-- ③ 品切れ管理（?admin=1 の時だけ表示） -->
        <div id="adminCard" class="adminPanel" style="display:none;">
          <div class="panelTitle" style="border-top:1px solid var(--line); border-bottom:1px solid var(--line); border-radius: 0;">品切れ設定（管理用）</div>
          <div style="padding:14px;">
            <p class="adminNote">
              URLに <strong>&amp;admin=1</strong> を付けた時だけ表示。例：<strong>.../index.html?table=8&amp;admin=1</strong><br>
              ここでONにした商品は「品切れ」になり、カート追加できません（状態はこの端末に保存）。
            </p>
            <div id="soldoutList"></div>
          </div>
        </div>
      </section>

      <!-- 右：カート + 履歴 -->
      <div class="rightCol">
        <section class="card" id="order-content">
          <div class="panelTitle">ご注文内容</div>
          <div class="cartBody">
            <ul id="cartList" class="cartList"></ul>

            <div class="sumRow">
              <span>合計</span>
              <span id="total" class="sumVal">¥0</span>
            </div>

            <button id="orderBtn" class="orderBtn" disabled>注文完了</button>
          </div>
        </section>

        <section class="card" id="history-content">
          <div class="panelTitle">注文履歴</div>
          <div class="historyBody">
            <div id="historyHint" class="adminNote" style="margin:0 0 10px; display:none;"></div>

            <!-- 管理用：会計（履歴クリア） -->
            <div id="adminHistoryControls" class="rowBtns" style="display:none; margin-bottom: 10px;">
              <button id="clearSessionBtn" class="tinyBtn dangerBtn">会計（履歴クリア）</button>
              <button id="refreshHistoryBtn" class="tinyBtn">再読み込み</button>
            </div>

            <ul id="historyList" class="historyList"></ul>
          </div>
        </section>
      </div>
    </div>

    <div class="foot">※ 表示価格は税込です</div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ② ありがとうございますモーダル -->
  <div id="thanksOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="注文完了">
      <p class="modalTitle">ご注文ありがとうございました！</p>
      <p class="modalText" id="thanksText">注文を受け付けました。</p>
      <button id="thanksClose" class="modalBtn">閉じる</button>
    </div>
  </div>

  <!-- モバイル用：下タブっぽいショートカット -->
  <div class="bottomTabs" aria-hidden="false">
    <button class="tabBtn" data-tab="menu">ホーム</button>
    <button class="tabBtn" data-tab="order">オーダー</button>
    <button class="tabBtn" data-tab="history">注文履歴</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      doc, getDoc, setDoc,
      query, where, orderBy, onSnapshot, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.firebasestorage.app",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const CATEGORIES = [
      { id:"osusume",    label:"おすすめ" },
      { id:"ippin",      label:"一品料理" },
      { id:"youniku",    label:"羊肉" },
      { id:"yasai",      label:"野菜" },
      { id:"gohan",      label:"ご飯類" },
      { id:"alcohol",    label:"アルコール" },
      { id:"nihonshu",   label:"日本酒" },
      { id:"wine",       label:"ワイン" },
      { id:"nonal",      label:"ノンアルコール" },
      { id:"other",      label:"その他" },
    ];

    // ② 骨付きラムチョップ画像（送ってくれた画像を埋め込み）
    const IMG_LAMB_CHOP = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYFxUZGBYfHysjGh0oHRUWJDUlKC0vMjIyGSI4PTcwPCsxMi8BCwsLDw4PHRISHjQhIig7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O//AABEIAWgB4AMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAIDBQYBB//EADkQAAIBAgQDBgQEBwAAAAAAAAABAgMRBBIhMQVBUWEGEyJxgZGhMkKxwdHh8BUjQlNicuH/xAAZAQADAQEBAAAAAAAAAAAAAAABAgMABAX/xAAmEQACAgICAgICAgMAAAAAAAAAAQIRAxIhMQRBEyJRYXGBkaHB/9oADAMBAAIRAxEAPwD2Gz1r2Pq6n+fQnG8w9F8l2k9m0mX8p2Wk1iGQk2fNQxv3j2mZfD8g9cXn1gQd8h2bWnB1J6Q6Vw8oJfQnLQmE3l5z2nqj7x4b4F7PqYcG7T3H0qJm6Hn1oKcQw1rY6fVwq6mK8m2Xn8g0p9oXk7u2l2h8h6g3a7xq9fWm0d5f7oG2iVbGm2d1YcVvQ9WfU9p8q3o3w1pX4vQ1x0cR0cY0cQkQpY0nqN5Gv8A0lq7bL0VQ7mT8k8o8ZfQe2F9o2i0q0m3l7a4mQzVvJQvNq6o0uKX1Hq7bqz1x1m1n0Y6l1mYq8a1W3mXzjv3x8S8m7c6p+qX1p5kU7q8qV5J0q3m5Zgq2l8mK3f1h4m0cUq0m0kq6cVY0l8n7pPp3p3q0t2c6dY9HqH2r7bqz8o0m0m3l7a4mQzVvJQvNq6o0uKX1Hq7bqz1x1m1n0Y6l1mYq8a1W3mXzjv3x8S8m7c6p+qX1p5kU7q8qV5J0q3m5Zgq2l8mK3f1h4m0cUq0m0kq6cVY0l8n7pPp3p3q0t2c6dY9HqH2r7bqz8o0m0m3l7a4mQzVvJQvNq6o0uKX1Hq7bqz1x1m1n0Y6l1mYq8a1W3mXzjv3x8S8m7c6p+qX1p5kU7q8qV5J0q3m5Zgq2l8mK3f1h4m0cUq0m0kq6cVY0l8n7pPp3p3q0t2c6dY9HqH2r7bqz8o//Z";

    const MENU = [
      { id:"lamb_raw",          category:"youniku", name:"生ラム", desc:"", price:1188, img:"" },
      { id:"lamb_raw_jyo",      category:"youniku", name:"上生ラム", desc:"", price:1518, img:"" },
      { id:"lamb_momo_steak",   category:"youniku", name:"生ラムモモステーキ", desc:"", price:1188, img:"" },
      { id:"lamb_tan_gokujo",   category:"youniku", name:"極上ラムタン", desc:"", price:1408, img:"" },
      { id:"mutton_hire",       category:"youniku", name:"マトンヒレ", desc:"", price:1298, img:"" },
      { id:"lamb_sirloin",      category:"youniku", name:"生ラムサーロイン", desc:"", price:1958, img:"" },
      { id:"lamb_ham_salad",    category:"youniku", name:"羊の生ハムサラダ風", desc:"", price:1078, img:"" },
      { id:"lamb_wiener_1",     category:"youniku", name:"ラムウィンナー（1本）", desc:"", price:253, img:"" },
      { id:"lamb_chop_1",       category:"youniku", name:"骨付きラムチョップ（1本）", desc:"", price:1298, img: IMG_LAMB_CHOP }, /* ② */
      { id:"aburi_nigiri_2",    category:"youniku", name:"炙り生ラムの握り（2貫）", desc:"", price:968, img:"" },

      { id:"yasai_moriawase",   category:"yasai", name:"野菜盛り合わせ", desc:"", price:748, img:"" },
      { id:"moyashi",           category:"yasai", name:"もやし", desc:"", price:418, img:"" },
      { id:"tamanegi",          category:"yasai", name:"玉ねぎ", desc:"", price:418, img:"" },
      { id:"naganegi",          category:"yasai", name:"長ネギ", desc:"", price:418, img:"" },
      { id:"kyabetsu",          category:"yasai", name:"キャベツ", desc:"", price:418, img:"" },
      { id:"ninniku_no_me",     category:"yasai", name:"ニンニクの芽", desc:"", price:418, img:"" },
      { id:"abura_add",         category:"yasai", name:"追加 脂代", desc:"（追加オプション）", price:110, img:"" },

      { id:"ume_kimchi",        category:"ippin", name:"さっぱり梅キムチ", desc:"", price:638, img:"" },
      { id:"kimchi_home",       category:"ippin", name:"ひつじやの手作りキムチ", desc:"", price:528, img:"" },
      { id:"kakuteki_home",     category:"ippin", name:"ひつじやの手作りカクテキ", desc:"", price:528, img:"" },
      { id:"moyashi_namul_std", category:"ippin", name:"もやしナムル スタンダード", desc:"", price:418, img:"" },
      { id:"moyashi_namul_hot", category:"ippin", name:"もやしナムル 辛口", desc:"", price:528, img:"" },
      { id:"kyuuri_zuke",       category:"ippin", name:"自家製きゅうり漬け", desc:"", price:528, img:"" },
      { id:"mozuku_su",         category:"ippin", name:"もずく酢", desc:"", price:528, img:"" },
      { id:"yamaimo_wasabi",    category:"ippin", name:"山芋山葵醤油漬け", desc:"", price:748, img:"" },
      { id:"tamago_soup",       category:"ippin", name:"卵スープ", desc:"", price:528, img:"" },
      { id:"wakame_soup",       category:"ippin", name:"わかめスープ", desc:"", price:528, img:"" },
      { id:"hitsujiya_reimen",  category:"ippin", name:"ひつじやの冷麺", desc:"", price:1078, img:"" },
      { id:"season_sherbet",    category:"ippin", name:"季節のシャーベット", desc:"", price:385, img:"" },

      { id:"koshihikari_m",     category:"gohan", name:"農家直送県内産コシヒカリ（中）", desc:"", price:308, img:"" },
      { id:"koshihikari_l",     category:"gohan", name:"農家直送県内産コシヒカリ（大）", desc:"", price:418, img:"" },
    ];

    const yen = (n) => "¥" + Number(n || 0).toLocaleString("ja-JP");

    const qs = new URLSearchParams(location.search);
    const tableParam = qs.get("table");
    const table = Number(tableParam);
    const tableOk = Number.isFinite(table) && table > 0;

    const isAdmin = qs.get("admin") === "1";

    const tablePill = document.getElementById("tablePill");
    const tableNoEl = document.getElementById("tableNo");
    const sessionPill = document.getElementById("sessionPill");
    const sessionShortEl = document.getElementById("sessionShort");

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=> t.style.display = "none", 2200);
    }

    if (tableOk) {
      tablePill.style.display = "inline-flex";
      tableNoEl.textContent = String(table);
    } else {
      toast("URLに ?table=1 のようにテーブル番号を付けてください");
    }

    // ========= セッション管理（履歴混ざり対策の本体） =========
    const tableStateRef = tableOk ? doc(db, "table_state", `table_${table}`) : null;
    let currentSessionId = null;

    function newSessionId(){
      return `s_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
    }

    async function loadSession(){
      if (!tableOk) return null;
      try{
        const snap = await getDoc(tableStateRef);
        if (snap.exists() && snap.data()?.sessionId) {
          currentSessionId = snap.data().sessionId;
        } else {
          // 初回：セッションが無ければ作る（ルールで書けない場合は後でフォールバック）
          const sid = newSessionId();
          try{
            await setDoc(tableStateRef, { table, sessionId: sid, updatedAt: serverTimestamp() }, { merge: true });
            currentSessionId = sid;
          } catch {
            // 書けない場合は端末ローカルで作る（※他端末と同期しない）
            currentSessionId = sid;
          }
        }
      } catch {
        currentSessionId = newSessionId();
      }

      // 表示
      sessionPill.style.display = "inline-flex";
      sessionShortEl.textContent = String(currentSessionId).slice(-6);

      return currentSessionId;
    }

    // ========= カート（テーブル+セッションで分離） =========
    const CART_KEY = tableOk ? `cart_table_${table}` : "cart_table_unknown";
    let cart = {};
    try{
      const saved = localStorage.getItem(CART_KEY);
      if (saved) cart = JSON.parse(saved) || {};
    } catch {}

    // ========= 品切れ（端末ローカル） =========
    const SOLDOUT_KEY = "soldout_map_v1";
    let soldOutMap = {};
    try{
      const saved = localStorage.getItem(SOLDOUT_KEY);
      if (saved) soldOutMap = JSON.parse(saved) || {};
    } catch {}
    const isSoldOut = (id) => !!soldOutMap[id];
    function setSoldOut(id, on){
      soldOutMap[id] = !!on;
      try{ localStorage.setItem(SOLDOUT_KEY, JSON.stringify(soldOutMap)); } catch {}
      renderMenu();
    }

    // ④ 商品ごとの「追加する数量」
    const draftQty = {};
    const getDraftQty = (id) => {
      if (!draftQty[id]) draftQty[id] = 1;
      return draftQty[id];
    };
    const setDraftQty = (id, n) => {
      const v = Math.max(1, Math.min(20, Number(n) || 1));
      draftQty[id] = v;
      const el = document.querySelector(`[data-draft-qty="${CSS.escape(id)}"]`);
      if (el) el.textContent = String(v);
      const minusBtn = document.querySelector(`[data-draft-minus="${CSS.escape(id)}"]`);
      if (minusBtn) minusBtn.disabled = v <= 1;
    };

    const catNavEl = document.getElementById("catNav");
    const drawerNavEl = document.getElementById("drawerNav");
    const menuEl = document.getElementById("menu");
    const cartListEl = document.getElementById("cartList");
    const totalEl = document.getElementById("total");
    const orderBtn = document.getElementById("orderBtn");

    // Drawer
    const hamburger = document.getElementById("hamburger");
    const drawer = document.getElementById("drawer");
    const drawerOverlay = document.getElementById("drawerOverlay");
    const drawerClose = document.getElementById("drawerClose");

    function openDrawer(){
      drawer.classList.add("show");
      drawerOverlay.classList.add("show");
      drawer.setAttribute("aria-hidden", "false");
    }
    function closeDrawer(){
      drawer.classList.remove("show");
      drawerOverlay.classList.remove("show");
      drawer.setAttribute("aria-hidden", "true");
    }
    hamburger?.addEventListener("click", openDrawer);
    drawerClose?.addEventListener("click", closeDrawer);
    drawerOverlay?.addEventListener("click", closeDrawer);

    // Bottom tabs
    const tabBtns = document.querySelectorAll(".tabBtn");
    function setActiveTab(key){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
    }
    function scrollToId(id){
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const k = btn.dataset.tab;
        if (k === "menu") scrollToId("menu-content");
        if (k === "order") scrollToId("order-content");
        if (k === "history") scrollToId("history-content");
        setActiveTab(k);
      });
    });
    setActiveTab("menu");

    function saveCart(){
      try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch {}
    }
    function cartItems(){
      return Object.values(cart).filter(x => x.qty > 0);
    }
    function cartQtyTotal(){
      return cartItems().reduce((sum, x) => sum + x.qty, 0);
    }
    function calcTotal(){
      return cartItems().reduce((sum, x) => sum + x.price * x.qty, 0);
    }

    function scrollToOrder(){
      scrollToId("order-content");
      setActiveTab("order");
    }

    function goCategory(catId){
      const el = document.getElementById(`cat-${catId}`);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      closeDrawer();
    }

    function renderNavInto(container){
      const counts = new Map();
      for (const c of CATEGORIES) counts.set(c.id, MENU.filter(m => m.category === c.id).length);

      const orderCount = cartQtyTotal();

      container.innerHTML = [
        `<a class="navBtn" data-nav="order" href="#order-content">
          <span>注文</span><small>${orderCount}</small>
        </a>`,
        `<a class="navBtn" data-nav="history" href="#history-content">
          <span>注文履歴</span><small>▶</small>
        </a>`,
        ...CATEGORIES.map(c => {
          const count = counts.get(c.id) ?? 0;
          return `<a class="navBtn" data-nav="${c.id}" href="#cat-${c.id}">
                    <span>${c.label}</span><small>${count}</small>
                  </a>`;
        })
      ].join("");

      container.querySelectorAll("a.navBtn").forEach(a => {
        a.addEventListener("click", (e) => {
          const key = a.getAttribute("data-nav");
          if (!key) return;
          e.preventDefault();
          if (key === "order") scrollToOrder();
          else if (key === "history") { scrollToId("history-content"); setActiveTab("history"); closeDrawer(); }
          else goCategory(key);
        });
      });
    }
    function renderNav(){
      renderNavInto(catNavEl);
      renderNavInto(drawerNavEl);
    }

    function renderMenu(){
      const byCat = new Map();
      for (const c of CATEGORIES) byCat.set(c.id, []);
      for (const m of MENU) {
        if (!byCat.has(m.category)) byCat.set(m.category, []);
        byCat.get(m.category).push(m);
      }

      menuEl.innerHTML = CATEGORIES.map(c => {
        const items = byCat.get(c.id) || [];
        const grid = items.map(m => {
          const sold = isSoldOut(m.id);
          const q = getDraftQty(m.id);
          const imgHtml = m.img
            ? `<div class="itemImg"><img src="${m.img}" alt="${m.name}"></div>`
            : `<div class="itemImg ph">NO IMAGE</div>`;

          return `
            <div class="itemCard" data-item="${m.id}">
              ${sold ? `<div class="soldOutBadge">品切れ</div>` : ``}

              ${imgHtml}

              <div style="min-width:0;">
                <h3>${m.name}</h3>
                <p class="desc">${m.desc || ""}</p>
                <p class="price">${yen(m.price)}</p>
              </div>

              <div class="addArea">
                <div class="stepper">
                  <button class="stepBtn" data-draft-minus="${m.id}" ${q<=1 ? "disabled":""} ${sold ? "disabled":""}>−</button>
                  <div class="stepQty" data-draft-qty="${m.id}">${q}</div>
                  <button class="stepBtn" data-draft-plus="${m.id}" ${sold ? "disabled":""}>＋</button>
                </div>

                <button class="addBtn2" data-add="${m.id}" ${sold ? "disabled":""}>カートに追加</button>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="section" id="cat-${c.id}">
            <div class="sectionHead">
              <h2>${c.label}</h2>
              <p>${items.length} 品</p>
            </div>
            <div class="menuGrid">
              ${grid || `<div style="color:var(--muted);padding:6px 10px;">（準備中）</div>`}
            </div>
          </div>
        `;
      }).join("");

      for (const m of MENU) setDraftQty(m.id, getDraftQty(m.id));
    }

    function renderCart(){
      const items = cartItems();
      if (!items.length){
        cartListEl.innerHTML = `<li style="color:var(--muted);padding:6px 2px;">（まだ商品が選ばれていません）</li>`;
      } else {
        cartListEl.innerHTML = items.map(x => `
          <li class="cartRow" data-id="${x.id}">
            <div style="min-width:0;">
              <div class="cartName">${x.name}</div>
              <div class="cartMeta">${yen(x.price)} / 1点</div>
            </div>
            <div class="qtyBox">
              <button class="qtyBtn" data-minus="${x.id}">−</button>
              <div class="qty">${x.qty}</div>
              <button class="qtyBtn" data-plus="${x.id}">＋</button>
            </div>
          </li>
        `).join("");
      }

      const total = calcTotal();
      totalEl.textContent = yen(total);
      orderBtn.disabled = !tableOk || !currentSessionId || total === 0;

      renderNav();
    }

    function addItem(id, qty){
      if (isSoldOut(id)) {
        toast("この商品は品切れです");
        return;
      }
      const m = MENU.find(x => x.id === id);
      if (!m) return;

      const n = Math.max(1, Math.min(20, Number(qty) || 1));
      if (!cart[id]) cart[id] = { id:m.id, name:m.name, price:m.price, qty:0 };
      cart[id].qty += n;

      saveCart();
      renderCart();
      toast(`${m.name} を +${n} 追加しました`);
    }

    function changeQty(id, delta){
      if (!cart[id]) return;
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      saveCart();
      renderCart();
    }

    // menu click
    menuEl.addEventListener("click", (e) => {
      const minus = e.target.closest("[data-draft-minus]");
      const plus  = e.target.closest("[data-draft-plus]");
      const add   = e.target.closest("[data-add]");

      if (minus) { setDraftQty(minus.getAttribute("data-draft-minus"), getDraftQty(minus.getAttribute("data-draft-minus")) - 1); return; }
      if (plus)  { setDraftQty(plus.getAttribute("data-draft-plus"), getDraftQty(plus.getAttribute("data-draft-plus")) + 1); return; }
      if (add)   { addItem(add.getAttribute("data-add"), getDraftQty(add.getAttribute("data-add"))); return; }
    });

    // cart click
    cartListEl.addEventListener("click", (e) => {
      const minus = e.target.closest("[data-minus]");
      const plus  = e.target.closest("[data-plus]");
      if (minus) changeQty(minus.dataset.minus, -1);
      if (plus)  changeQty(plus.dataset.plus, +1);
    });

    // Thanks modal
    const thanksOverlay = document.getElementById("thanksOverlay");
    const thanksText = document.getElementById("thanksText");
    const thanksClose = document.getElementById("thanksClose");
    function openThanks(message){
      thanksText.textContent = message;
      thanksOverlay.classList.add("show");
      thanksOverlay.setAttribute("aria-hidden", "false");
    }
    function closeThanks(){
      thanksOverlay.classList.remove("show");
      thanksOverlay.setAttribute("aria-hidden", "true");
    }
    thanksClose.addEventListener("click", closeThanks);
    thanksOverlay.addEventListener("click", (e) => { if (e.target === thanksOverlay) closeThanks(); });

    // ========= 注文送信 =========
    orderBtn.addEventListener("click", async () => {
      if (!tableOk) { toast("テーブル番号が無効です"); return; }
      if (!currentSessionId) { toast("セッション取得中です。少し待ってください"); return; }

      const items = cartItems();
      const total = calcTotal();
      if (!items.length || total <= 0) { toast("商品を選んでください"); return; }

      orderBtn.disabled = true;
      orderBtn.textContent = "送信中…";

      try{
        const docRef = await addDoc(collection(db, "orders"), {
          table,
          sessionId: currentSessionId,   // ★混ざり防止の鍵
          items: items.map(x => ({ name: x.name, qty: x.qty, price: x.price })),
          total,
          status: "new",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        cart = {};
        saveCart();
        renderCart();

        openThanks(`ご注文ありがとうございました。\n注文番号：${docRef.id}`);
        toast("注文を送信しました。ありがとうございます！");
        scrollToId("history-content");
        setActiveTab("history");
      } catch(err){
        console.error(err);
        toast("送信に失敗しました（設定/ルールを確認）");
      } finally {
        orderBtn.textContent = "注文完了";
        orderBtn.disabled = !tableOk || !currentSessionId || calcTotal() === 0;
      }
    });

    // ========= 注文履歴（table + sessionId で表示） =========
    const historyListEl = document.getElementById("historyList");
    const historyHintEl = document.getElementById("historyHint");
    const adminHistoryControls = document.getElementById("adminHistoryControls");
    const clearSessionBtn = document.getElementById("clearSessionBtn");
    const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");

    let unsubscribeHistory = null;

    function fmtTime(ts){
      try{
        if (!ts) return "—";
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      } catch { return "—"; }
    }

    function renderHistoryEmpty(){
      historyListEl.innerHTML = `<li style="color:var(--muted);font-weight:900;">（このセッションの注文履歴はまだありません）</li>`;
    }

    function bindHistory(){
      if (!tableOk || !currentSessionId) { renderHistoryEmpty(); return; }

      if (unsubscribeHistory) unsubscribeHistory();

      const qy = query(
        collection(db, "orders"),
        where("table", "==", table),
        where("sessionId", "==", currentSessionId),
        orderBy("createdAt", "desc")
      );

      unsubscribeHistory = onSnapshot(qy, (snap) => {
        if (snap.empty) { renderHistoryEmpty(); return; }

        const rows = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const itemsText = (d.items || []).map(it => `・${it.name} ×${it.qty}`).join("\n");
          rows.push({ id, d, itemsText });
        });

        historyListEl.innerHTML = rows.map(r => `
          <li class="historyCard" data-oid="${r.id}">
            <div class="historyTop">
              <div class="historyTime">${fmtTime(r.d.createdAt)} / テーブル${r.d.table}</div>
              <div class="historyTotal">${yen(r.d.total)}</div>
            </div>
            <div class="historyItems">${r.itemsText || ""}</div>

            ${isAdmin ? `
              <div class="rowBtns">
                <button class="tinyBtn dangerBtn" data-del="${r.id}">完全削除</button>
              </div>
              <div style="color:rgba(255,255,255,.45);font-size:12px;font-weight:900;margin-top:6px;">
                ※「完全削除」はFirestoreルールでdelete許可が必要。できない場合は会計（履歴クリア）を使ってください。
              </div>
            ` : ``}
          </li>
        `).join("");
      }, (err) => {
        console.error(err);
        historyListEl.innerHTML = `<li style="color:var(--muted);font-weight:900;">（履歴の取得に失敗しました。Firestoreルール/インデックスを確認）</li>`;
      });
    }

    // 管理：会計（履歴クリア）＝ sessionId を更新
    async function clearSession(){
      if (!tableOk) return;
      const ok = confirm("会計（履歴クリア）しますか？\nこのテーブルの“新しいお客様の回”に切り替わります。");
      if (!ok) return;

      const sid = newSessionId();
      try{
        await setDoc(tableStateRef, { table, sessionId: sid, updatedAt: serverTimestamp() }, { merge: true });
        currentSessionId = sid;
        sessionShortEl.textContent = String(currentSessionId).slice(-6);
        toast("会計しました（新セッションに切替）");
        cart = {};
        saveCart();
        renderCart();
        bindHistory();
      } catch(err){
        console.error(err);
        toast("会計に失敗（table_state への書き込み権限が必要）");
      }
    }

    // 管理：完全削除（可能なら）
    historyListEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-del]");
      if (!btn) return;
      const id = btn.getAttribute("data-del");
      const ok = confirm("この注文を完全削除しますか？（戻せません）");
      if (!ok) return;

      try{
        await deleteDoc(doc(db, "orders", id));
        toast("削除しました");
      } catch(err){
        console.error(err);
        toast("削除できません（Firestoreルールでdeleteを許可していない可能性）");
      }
    });

    clearSessionBtn?.addEventListener("click", clearSession);
    refreshHistoryBtn?.addEventListener("click", () => { bindHistory(); toast("更新しました"); });

    // ========= 管理：品切れUI =========
    const adminCard = document.getElementById("adminCard");
    const soldoutListEl = document.getElementById("soldoutList");

    function renderAdminSoldOut(){
      if (!isAdmin) return;
      adminCard.style.display = "block";

      const ordered = [];
      for (const c of CATEGORIES) {
        const items = MENU.filter(m => m.category === c.id);
        for (const m of items) ordered.push({ c, m });
      }

      soldoutListEl.innerHTML = ordered.map(({c, m}) => {
        const on = isSoldOut(m.id);
        return `
          <div class="toggleRow">
            <div style="min-width:0;">
              <strong>${m.name}</strong>
              <div style="color:var(--muted);font-size:12px;font-weight:900;margin-top:2px;">${c.label}</div>
            </div>
            <label>
              <input type="checkbox" data-soldout-toggle="${m.id}" ${on ? "checked":""}>
              品切れ
            </label>
          </div>
        `;
      }).join("");

      soldoutListEl.querySelectorAll("[data-soldout-toggle]").forEach(inp => {
        inp.addEventListener("change", () => {
          const id = inp.getAttribute("data-soldout-toggle");
          setSoldOut(id, inp.checked);
          toast(inp.checked ? "品切れにしました" : "品切れ解除しました");
        });
      });
    }

    // ========= 初期描画 =========
    renderNav();
    renderMenu();
    renderCart();

    // 管理用表示
    if (isAdmin){
      historyHintEl.style.display = "block";
      historyHintEl.textContent = "管理モード：会計（履歴クリア）で前の客の履歴が表示されないようにできます。";
      adminHistoryControls.style.display = "flex";
    }

    // セッション読み込み → 履歴バインド
    await loadSession();
    renderCart();
    bindHistory();
    renderAdminSoldOut();
  </script>
</body>
</html>
