<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>注文</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; background:#f6f7fb; }
    header { padding:18px 16px; background:#111827; color:#fff; }
    main { max-width: 920px; margin: 0 auto; padding: 16px; display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin:0; font-size: 20px; }
    h2 { margin:0 0 10px; font-size: 16px; }
    .menu { display:grid; gap:10px; }
    .item { display:flex; align-items:center; justify-content:space-between; border:1px solid #eef0f5; border-radius:12px; padding:12px; }
    .item b { font-size: 15px; }
    .qty { display:flex; align-items:center; gap:8px; }
    button { cursor:pointer; border:0; border-radius:10px; padding:10px 12px; font-weight:600; }
    .btn { background:#111827; color:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn2 { background:#eef2ff; color:#111827; }
    .danger { background:#fee2e2; color:#7f1d1d; }
    input, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6e8ef; font-size:14px; box-sizing:border-box; }
    textarea { min-height: 90px; resize: vertical; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .muted { opacity:.75; font-size: 13px; }
    ul { margin: 8px 0 0; padding-left: 18px; }
    .total { font-size: 18px; font-weight: 800; }
  </style>
</head>
<body>
  <header>
    <h1>注文ページ <span id="tableLabel" class="muted"></span></h1>
  </header>

  <main>
    <section class="card">
      <h2>メニュー</h2>
      <div id="menu" class="menu"></div>
    </section>

    <aside class="card">
      <h2>カート</h2>
      <div class="muted">※ QRで開く想定：URLに <code>?table=1</code> のように付けてください。</div>

      <div style="height:12px"></div>
      <div class="row">
        <div>
          <div class="muted">テーブル番号</div>
          <input id="tableInput" type="number" min="1" placeholder="例：1" />
        </div>
        <div>
          <div class="muted">人数（任意）</div>
          <input id="peopleInput" type="number" min="1" placeholder="例：2" />
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="muted">備考（アレルギー等）</div>
      <textarea id="noteInput" placeholder="例：辛さ控えめ、など"></textarea>

      <div style="height:14px"></div>
      <div id="cartEmpty" class="muted">まだ何も入っていません。</div>
      <ul id="cartList"></ul>

      <div style="height:14px"></div>
      <div class="row">
        <button id="clearBtn" class="btn2">カートを空にする</button>
        <button id="submitBtn" class="btn">注文を送信</button>
      </div>

      <div style="height:12px"></div>
      <div class="total">合計：<span id="total">0</span> 円</div>
      <div id="status" class="muted" style="margin-top:10px;"></div>
    </aside>
  </main>

  <script type="module">
    import { MENU } from "./menu.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== Firebase config（君のもの）=====
    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.firebasestorage.app",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d",
      measurementId: "G-84PBP7PZNM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== UI & state =====
    const qs = new URLSearchParams(location.search);
    const tableFromUrl = qs.get("table");

    const menuEl = document.getElementById("menu");
    const tableLabel = document.getElementById("tableLabel");
    const tableInput = document.getElementById("tableInput");
    const peopleInput = document.getElementById("peopleInput");
    const noteInput = document.getElementById("noteInput");
    const cartList = document.getElementById("cartList");
    const cartEmpty = document.getElementById("cartEmpty");
    const totalEl = document.getElementById("total");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");

    if (tableFromUrl) {
      tableInput.value = String(tableFromUrl);
      tableLabel.textContent = `(テーブル ${tableFromUrl})`;
    }

    // cart: { id: {id,name,price,qty} }
    const cart = new Map();

    function yen(n){ return new Intl.NumberFormat("ja-JP").format(n); }

    function calcTotal() {
      let t = 0;
      for (const v of cart.values()) t += v.price * v.qty;
      return t;
    }

    function renderCart() {
      cartList.innerHTML = "";
      const items = Array.from(cart.values());
      cartEmpty.style.display = items.length ? "none" : "block";

      for (const it of items) {
        const li = document.createElement("li");
        li.innerHTML = `${it.name} × ${it.qty}（${yen(it.price * it.qty)}円）`;
        cartList.appendChild(li);
      }
      totalEl.textContent = yen(calcTotal());
    }

    function addToCart(m) {
      const cur = cart.get(m.id);
      cart.set(m.id, cur ? { ...cur, qty: cur.qty + 1 } : { ...m, qty: 1 });
      renderCart();
    }

    function decFromCart(m) {
      const cur = cart.get(m.id);
      if (!cur) return;
      if (cur.qty <= 1) cart.delete(m.id);
      else cart.set(m.id, { ...cur, qty: cur.qty - 1 });
      renderCart();
    }

    function renderMenu() {
      menuEl.innerHTML = "";
      for (const m of MENU) {
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div>
            <b>${m.name}</b>
            <div class="muted">${yen(m.price)} 円</div>
          </div>
          <div class="qty">
            <button class="btn2" data-dec="${m.id}">−</button>
            <button class="btn" data-add="${m.id}">＋</button>
          </div>
        `;
        menuEl.appendChild(row);
      }

      menuEl.addEventListener("click", (e) => {
        const addId = e.target?.getAttribute?.("data-add");
        const decId = e.target?.getAttribute?.("data-dec");
        if (addId) addToCart(MENU.find(x => x.id === addId));
        if (decId) decFromCart(MENU.find(x => x.id === decId));
      });
    }

    renderMenu();
    renderCart();

    clearBtn.addEventListener("click", () => {
      cart.clear();
      renderCart();
      statusEl.textContent = "";
    });

    async function submitOrder() {
      statusEl.textContent = "";
      const table = Number(tableInput.value);
      const people = peopleInput.value ? Number(peopleInput.value) : null;
      const note = noteInput.value?.trim() ?? "";

      if (!Number.isFinite(table) || table <= 0) {
        statusEl.textContent = "テーブル番号を正しく入力してください。";
        return;
      }
      const items = Array.from(cart.values()).map(v => ({ id: v.id, name: v.name, price: v.price, qty: v.qty }));
      if (items.length === 0) {
        statusEl.textContent = "カートが空です。";
        return;
      }
      const total = calcTotal();

      submitBtn.disabled = true;
      submitBtn.textContent = "送信中…";

      try {
        await addDoc(collection(db, "orders"), {
          table,
          people,
          note,
          items,
          total,
          status: "new",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        cart.clear();
        renderCart();
        statusEl.textContent = "注文を送信しました。";
      } catch (err) {
        statusEl.textContent = "送信エラー: " + (err?.message ?? String(err));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "注文を送信";
      }
    }

    submitBtn.addEventListener("click", submitOrder);
  </script>
</body>
</html>
