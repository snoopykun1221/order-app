<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ³¨æ–‡ç®¡ç†</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; background:#f6f7fb; }
    header { padding:18px 16px; background:#0b1220; color:#fff; }
    main { max-width: 1180px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin:0; font-size:20px; }
    h2 { margin:0 0 10px; font-size:16px; }
    input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6e8ef; font-size:14px; box-sizing:border-box; }
    button { cursor:pointer; border:0; border-radius:10px; padding:10px 12px; font-weight:900; }
    .btn { background:#0b1220; color:#fff; }
    .btn2 { background:#eef2ff; color:#0b1220; }
    .danger { background:#fee2e2; color:#7f1d1d; }
    .muted { opacity:.75; font-size:13px; }
    .order { border:1px solid #eef0f5; border-radius:14px; padding:14px; margin:12px 0; background:#fff; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .tag { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#eef2ff; }
    .tagDone { background:#dcfce7; color:#14532d; }
    .tagCancel { background:#fee2e2; color:#7f1d1d; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    ul { margin: 6px 0 0; padding-left: 18px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .small { padding:8px 10px; }

    .nav { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .navbtn {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:12px; border:1px solid #eef0f5;
      background:#fff; cursor:pointer; font-weight:900;
    }
    .navbtn.active { background:#0b1220; color:#fff; border-color:#0b1220; }
    .badge {
      font-size:12px; font-weight:900; padding:3px 8px; border-radius:999px;
      background:#eef2ff; color:#0b1220;
    }
    .navbtn.active .badge { background:rgba(255,255,255,.2); color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>æ³¨æ–‡ç®¡ç†ç”»é¢</h1>
  </header>

  <main class="grid">
    <section class="card">
      <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>

      <div class="row">
        <input id="email" type="email" placeholder="ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«">
        <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="loginBtn" class="btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="btn2" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div style="height:10px"></div>
      <div id="authState" class="muted">æœªãƒ­ã‚°ã‚¤ãƒ³</div>

      <hr style="border:none;border-top:1px solid #eef0f5;margin:16px 0;">

      <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <div class="muted">æŠ¼ã—ãŸã‚‰è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™</div>
      <div class="nav">
        <div id="navNew" class="navbtn active" role="button" tabindex="0">
          <span>æœªå®Œäº†</span><span id="cntNew" class="badge">0</span>
        </div>
        <div id="navDone" class="navbtn" role="button" tabindex="0">
          <span>å®Œäº†</span><span id="cntDone" class="badge">0</span>
        </div>
        <div id="navAll" class="navbtn" role="button" tabindex="0">
          <span>ä¸€è¦§</span><span id="cntAll" class="badge">0</span>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="muted">â€»ã€Œå–æ¶ˆã€ã¯ä¸€è¦§ã§ç¢ºèªã§ãã¾ã™</div>
    </section>

    <section class="card">
      <h2 id="listTitle">æœªå®Œäº†</h2>
      <div id="info" class="muted">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      <div id="orders"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.firebasestorage.app",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authState = document.getElementById("authState");

    const ordersEl = document.getElementById("orders");
    const infoEl = document.getElementById("info");
    const listTitleEl = document.getElementById("listTitle");

    const navNew = document.getElementById("navNew");
    const navDone = document.getElementById("navDone");
    const navAll = document.getElementById("navAll");

    const cntNew = document.getElementById("cntNew");
    const cntDone = document.getElementById("cntDone");
    const cntAll = document.getElementById("cntAll");

    let unsub = null;
    let initialized = false;
    let latestDocs = [];
    let currentView = "new"; // "new" | "done" | "all"

    // æ–°è¦æ³¨æ–‡ã®é€šçŸ¥éŸ³ï¼ˆæœªå®Œäº†ãŒè¿½åŠ ã•ã‚ŒãŸæ™‚ã ã‘ï¼‰
    function beep() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.value = 880;
      gain.gain.value = 0.08;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => { osc.stop(); ctx.close(); }, 160);
    }

    function safeText(v, fallback="-") {
      if (v === null || v === undefined) return fallback;
      const s = String(v).trim();
      return s.length ? s : fallback;
    }

    function statusLabel(s) {
      if (s === "done") return { text:"å®Œäº†", cls:"tagDone" };
      if (s === "canceled") return { text:"å–æ¶ˆ", cls:"tagCancel" };
      return { text:"æœªå®Œäº†", cls:"" };
    }

    function statusPriority(s) {
      if (s === "done") return 1;
      if (s === "canceled") return 2;
      return 0; // æœªå®Œäº†
    }

    function createdMillis(data) {
      const ts = data?.createdAt;
      if (ts?.toDate) return ts.toDate().getTime();
      if (typeof ts === "number") return ts;
      return 0;
    }

    function setActiveNav(view) {
      currentView = view;
      navNew.classList.toggle("active", view === "new");
      navDone.classList.toggle("active", view === "done");
      navAll.classList.toggle("active", view === "all");

      if (view === "new") listTitleEl.textContent = "æœªå®Œäº†";
      if (view === "done") listTitleEl.textContent = "å®Œäº†";
      if (view === "all") listTitleEl.textContent = "ä¸€è¦§ï¼ˆæœªå®Œäº†ãŒä¸Šï¼‰";

      render();
    }

    function updateCounts() {
      const all = latestDocs.length;
      const done = latestDocs.filter(d => (d.data.status ?? "new") === "done").length;
      const canceled = latestDocs.filter(d => (d.data.status ?? "new") === "canceled").length;
      const unfinished = latestDocs.filter(d => {
        const s = d.data.status ?? "new";
        return s !== "done" && s !== "canceled";
      }).length;

      cntAll.textContent = String(all);
      cntDone.textContent = String(done);
      cntNew.textContent = String(unfinished);

      infoEl.textContent = `ä»¶æ•°: ${all}ï¼ˆæœªå®Œäº†:${unfinished} / å®Œäº†:${done} / å–æ¶ˆ:${canceled}ï¼‰`;
    }

    function filteredDocsSorted() {
      let docs = latestDocs.slice();

      if (currentView === "all") {
        docs.sort((a, b) => {
          const sa = statusPriority(a.data.status ?? "new");
          const sb = statusPriority(b.data.status ?? "new");
          if (sa !== sb) return sa - sb; // æœªå®Œäº†â†’å®Œäº†â†’å–æ¶ˆ
          return createdMillis(b.data) - createdMillis(a.data); // æ–°ã—ã„é †
        });
        return docs;
      }

      if (currentView === "done") {
        docs = docs.filter(d => (d.data.status ?? "new") === "done");
        docs.sort((a, b) => createdMillis(b.data) - createdMillis(a.data));
        return docs;
      }

      // æœªå®Œäº†
      docs = docs.filter(d => {
        const s = d.data.status ?? "new";
        return s !== "done" && s !== "canceled";
      });
      docs.sort((a, b) => createdMillis(b.data) - createdMillis(a.data));
      return docs;
    }

    function render() {
      const docs = filteredDocsSorted();

      if (!docs.length) {
        ordersEl.innerHTML = "<div class='muted' style='margin-top:10px;'>è¡¨ç¤ºã™ã‚‹æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
        return;
      }

      ordersEl.innerHTML = docs.map(d => {
        const data = d.data || {};
        const table = safeText(data.table, "-");
        const total = safeText(data.total, "0");
        const st = data.status ?? "new";
        const tag = statusLabel(st);

        const items = Array.isArray(data.items) ? data.items : [];
        const itemsHtml = items.length
          ? items.map(i => {
              const name = safeText(i?.name, "-");
              const qty = safeText(i?.qty, "1");
              return `<li>${name} Ã— ${qty}</li>`;
            }).join("")
          : "<li>(å•†å“ãªã—)</li>";

        return `
          <div class="order" data-id="${d.id}">
            <div class="top">
              <div>
                <div style="font-weight:900; font-size:16px;">ãƒ†ãƒ¼ãƒ–ãƒ« ${table}</div>
                <div class="muted">åˆè¨ˆ: ${total} å††</div>
              </div>
              <span class="tag ${tag.cls}">${tag.text}</span>
            </div>

            <ul>${itemsHtml}</ul>

            <div class="actions">
              <button class="btn small" data-s="done">å®Œäº†</button>
              <button class="danger small" data-s="canceled">å–æ¶ˆ</button>
              <button class="btn2 small" data-s="new">æœªå®Œäº†</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function listen() {
      if (unsub) unsub();

      const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      unsub = onSnapshot(q, snap => {
        // åˆå›ãƒ­ãƒ¼ãƒ‰å¾Œã«ã€Œæœªå®Œäº†ã®è¿½åŠ ã€ã ã‘é³´ã‚‰ã™
        if (initialized) {
          let hasNew = false;
          for (const ch of snap.docChanges()) {
            if (ch.type === "added") {
              const s = ch.doc.data().status ?? "new";
              if (s !== "done" && s !== "canceled") hasNew = true;
            }
          }
          if (hasNew) beep();
        }
        initialized = true;

        latestDocs = snap.docs.map(x => ({ id: x.id, data: x.data() }));
        updateCounts();
        render();
      }, err => {
        infoEl.textContent = "èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: " + (err?.message ?? String(err));
      });
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼šã‚¿ãƒ–ã¯åˆ‡ã‚Šæ›¿ãˆãªã„ï¼ˆè‡ªç„¶ã«æ¶ˆãˆã‚‹ã ã‘ï¼‰
    ordersEl.addEventListener("click", async e => {
      const btn = e.target.closest("button[data-s]");
      if (!btn) return;
      const wrap = e.target.closest(".order");
      const id = wrap?.dataset?.id;
      if (!id) return;

      const nextStatus = btn.dataset.s;

      try {
        await updateDoc(doc(db, "orders", id), {
          status: nextStatus,
          updatedAt: serverTimestamp()
        });
        // ğŸ‘‡ è‡ªå‹•ã§ã‚¿ãƒ–ç§»å‹•ã—ãªã„
        // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã§è¡¨ç¤ºãŒè‡ªç„¶ã«å¤‰ã‚ã‚‹
      } catch (err) {
        infoEl.textContent = "æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + (err?.message ?? String(err));
      }
    });

    // å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    navNew.addEventListener("click", () => setActiveNav("new"));
    navDone.addEventListener("click", () => setActiveNav("done"));
    navAll.addEventListener("click", () => setActiveNav("all"));

    // ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    loginBtn.onclick = async () => {
      infoEl.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      } catch (err) {
        infoEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (err?.message ?? String(err));
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authState.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + (user.email ?? "");
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        setActiveNav("new"); // ãƒ‡ãƒ•ã‚©ã¯æœªå®Œäº†
        listen();
      } else {
        authState.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        ordersEl.innerHTML = "";
        latestDocs = [];
        initialized = false;
        cntAll.textContent = "0";
        cntDone.textContent = "0";
        cntNew.textContent = "0";
        listTitleEl.textContent = "æœªå®Œäº†";
        infoEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™";
        if (unsub) unsub();
        unsub = null;
      }
    });
  </script>
</body>
</html>
