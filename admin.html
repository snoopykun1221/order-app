<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>注文管理（Admin）</title>
  <style>
    body{font-family:system-ui,-apple-system,sans-serif;margin:0;background:#0b0f14;color:#e8eef6}
    header{position:sticky;top:0;background:#0b0f14;border-bottom:1px solid #1c2633;padding:14px 16px;z-index:10}
    h1{font-size:18px;margin:0 0 6px}
    .topnote{color:#a9b6c6;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{font:inherit}
    input,select{background:#0f1620;border:1px solid #253243;color:#e8eef6;border-radius:10px;padding:10px 12px}
    button{background:#6e56cf;border:0;color:white;border-radius:10px;padding:10px 12px;cursor:pointer}
    button.secondary{background:#1f2a38}
    button.danger{background:#b00020}
    button:disabled{opacity:.55;cursor:not-allowed}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:#a9b6c6;font-size:13px;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:#0f1620;border:1px solid #253243;border-radius:14px;padding:14px}
    .items{margin-top:10px;border-top:1px solid #253243;padding-top:10px}
    .items table{width:100%;border-collapse:collapse;font-size:14px}
    .items th,.items td{padding:8px 6px;border-bottom:1px solid #1c2633}
    .right{text-align:right}
    .status{display:inline-flex;align-items:center;gap:8px;font-size:13px;margin-top:8px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #253243;background:#0b0f14}
    .pill.placed{border-color:#3a4b63}
    .pill.preparing{border-color:#8a6cff}
    .pill.served{border-color:#2ea043}
    .pill.paid{border-color:#20c997}
    .pill.canceled{border-color:#ff6b6b}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .small{font-size:12px;color:#a9b6c6}

    /* login */
    #loginBox{max-width:560px;margin:18px auto;background:#0f1620;border:1px solid #253243;border-radius:14px;padding:16px}
    #loginBox h2{font-size:16px;margin:0 0 12px}
    #loginErr{display:none;margin-top:10px;color:#ffb4c0}
    #adminApp{display:none}
  </style>
</head>
<body>
  <header>
    <h1>注文管理（Admin）</h1>
    <div class="topnote" id="who">未ログイン</div>
  </header>

  <!-- ログイン -->
  <div id="loginBox">
    <h2>管理者ログイン</h2>
    <div class="row">
      <input id="email" type="email" placeholder="メール" style="flex:1;min-width:220px" />
      <input id="password" type="password" placeholder="パスワード" style="flex:1;min-width:220px" />
      <button id="loginBtn">ログイン</button>
    </div>
    <div id="loginErr"></div>
    <div class="small" style="margin-top:10px;">
      ※ログイン後に注文一覧が表示されます。
    </div>
  </div>

  <!-- 管理画面本体（ログイン後に表示） -->
  <div id="adminApp">
    <header style="border-bottom:none;padding-top:0">
      <div class="row">
        <input id="tableFilter" placeholder="テーブル番号（例: 12）" style="width:180px" />
        <select id="statusFilter">
          <option value="all">全ステータス</option>
          <option value="placed">placed（新規）</option>
          <option value="preparing">preparing（調理中）</option>
          <option value="served">served（提供済）</option>
          <option value="paid">paid（会計済）</option>
          <option value="canceled">canceled（キャンセル）</option>
        </select>
        <button id="refreshBtn" class="secondary">再読込</button>
        <button id="logoutBtn" class="secondary">ログアウト</button>
      </div>
    </header>

    <main>
      <div class="meta">
        <div>表示件数: <span id="count">0</span></div>
        <div>最終更新: <span id="updatedAt">-</span></div>
      </div>
      <div class="grid" id="list"></div>
    </main>
  </div>

  <!-- Firebase SDK（compat） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // Firebase設定（あなたのプロジェクト）
    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.appspot.com",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // elements
    const who = document.getElementById("who");
    const loginBox = document.getElementById("loginBox");
    const adminApp = document.getElementById("adminApp");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginErr = document.getElementById("loginErr");

    const listEl = document.getElementById("list");
    const countEl = document.getElementById("count");
    const updatedAtEl = document.getElementById("updatedAt");
    const tableFilterEl = document.getElementById("tableFilter");
    const statusFilterEl = document.getElementById("statusFilter");
    const refreshBtn = document.getElementById("refreshBtn");

    let unsub = null;

    function fmtYen(n){ try { return Number(n||0).toLocaleString("ja-JP"); } catch { return String(n||0); } }
    function fmtTime(ts){
      if (!ts) return "-";
      if (typeof ts === "string") return ts;
      if (ts.toDate) return ts.toDate().toLocaleString("ja-JP");
      return String(ts);
    }
    function pillClass(status){
      return ["placed","preparing","served","paid","canceled"].includes(status) ? status : "placed";
    }

    async function updateStatus(orderId, status){
      await db.collection("orders").doc(orderId).update({
        status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function renderCard(doc){
      const data = doc.data() || {};
      const orderId = doc.id;
      const tableNo = data.tableNo ?? data.table ?? data.table_number ?? "";
      const status = data.status || "placed";
      const createdAt = data.createdAt || data.created_at;
      const total = data.total ?? data.amount ?? 0;
      const items = Array.isArray(data.items) ? data.items : [];

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="meta">
          <div><b>注文ID:</b> <span class="small">${orderId}</span></div>
          <div><b>テーブル:</b> ${tableNo || "-"}</div>
          <div><b>作成:</b> ${fmtTime(createdAt)}</div>
          <div><b>合計:</b> ${fmtYen(total)} 円</div>
        </div>

        <div class="status">
          <span class="pill ${pillClass(status)}">${status}</span>
          <span class="small">${data.updatedAt ? "更新: " + fmtTime(data.updatedAt) : ""}</span>
        </div>

        <div class="items">
          <table>
            <thead>
              <tr>
                <th>商品</th>
                <th class="right">単価</th>
                <th class="right">数量</th>
                <th class="right">小計</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(it=>{
                const name = it.name ?? it.id ?? "item";
                const price = Number(it.price ?? it.unitPrice ?? 0);
                const qty = Number(it.qty ?? 0);
                const sub = price * qty;
                return `
                  <tr>
                    <td>${String(name)}</td>
                    <td class="right">${fmtYen(price)}</td>
                    <td class="right">${fmtYen(qty)}</td>
                    <td class="right">${fmtYen(sub)}</td>
                  </tr>
                `;
              }).join("") || `<tr><td colspan="4" class="small">items が空です</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="actions">
          <button class="secondary" data-act="placed">新規</button>
          <button class="secondary" data-act="preparing">調理中</button>
          <button class="secondary" data-act="served">提供済</button>
          <button class="secondary" data-act="paid">会計済</button>
          <button class="danger" data-act="canceled">キャンセル</button>
        </div>
      `;

      div.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          btn.disabled = true;
          try{
            if (act === "canceled" && !confirm("この注文をキャンセルにしますか？")) return;
            await updateStatus(orderId, act);
          } catch(e){
            console.error(e);
            alert("更新に失敗しました（Consoleを確認）");
          } finally {
            btn.disabled = false;
          }
        });
      });

      return div;
    }

    function applyClientFilter(docs){
      const t = tableFilterEl.value.trim();
      const s = statusFilterEl.value;
      return docs.filter(doc=>{
        const data = doc.data() || {};
        const tableNo = String(data.tableNo ?? data.table ?? data.table_number ?? "");
        const status = String(data.status || "placed");
        if (t && tableNo !== t) return false;
        if (s !== "all" && status !== s) return false;
        return true;
      });
    }

    function startListen(){
      if (unsub) unsub();

      const q = db.collection("orders").orderBy("createdAt", "desc").limit(100);
      unsub = q.onSnapshot((snap)=>{
        const docsAll = snap.docs;
        const docs = applyClientFilter(docsAll);

        listEl.innerHTML = "";
        docs.forEach(d => listEl.appendChild(renderCard(d)));

        countEl.textContent = String(docs.length);
        updatedAtEl.textContent = new Date().toLocaleString("ja-JP");
      }, (err)=>{
        console.error(err);
        alert("Firestoreの読み込みに失敗しました（Consoleを確認）");
      });
    }

    tableFilterEl.addEventListener("input", ()=> startListen());
    statusFilterEl.addEventListener("change", ()=> startListen());
    refreshBtn.addEventListener("click", ()=> startListen());

    // ログインボタン
    loginBtn.addEventListener("click", async ()=>{
      loginErr.style.display = "none";
      loginErr.textContent = "";

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      try{
        loginBtn.disabled = true;
        await auth.signInWithEmailAndPassword(email, password);
      }catch(e){
        console.error(e);
        loginErr.textContent = "ログイン失敗: " + (e?.message || e);
        loginErr.style.display = "block";
      }finally{
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async ()=> {
      await auth.signOut();
    });

    // ログイン状態で表示切替（←ここが肝）
    auth.onAuthStateChanged((user)=>{
      if (user){
        who.textContent = `ログイン中: ${user.email}`;
        loginBox.style.display = "none";
        adminApp.style.display = "block";
        startListen(); // ログイン後に初めて読む
      } else {
        who.textContent = "未ログイン";
        adminApp.style.display = "none";
        loginBox.style.display = "block";
        if (unsub) { unsub(); unsub = null; }
      }
    });
  </script>
</body>
</html>
