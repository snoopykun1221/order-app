<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>注文管理</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; background:#f6f7fb; }
    header { padding:18px 16px; background:#0b1220; color:#fff; }
    main { max-width: 1080px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin:0; font-size:20px; }
    h2 { margin:0 0 10px; font-size:16px; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6e8ef; font-size:14px; box-sizing:border-box; }
    button { cursor:pointer; border:0; border-radius:10px; padding:10px 12px; font-weight:700; }
    .btn { background:#0b1220; color:#fff; }
    .btn2 { background:#eef2ff; color:#0b1220; }
    .danger { background:#fee2e2; color:#7f1d1d; }
    .muted { opacity:.75; font-size:13px; }
    .order { border:1px solid #eef0f5; border-radius:14px; padding:14px; margin:12px 0; background:#fff; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .tag { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; background:#eef2ff; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    ul { margin: 6px 0 0; padding-left: 18px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .small { padding:8px 10px; }
    a { color: inherit; }
  </style>
</head>
<body>
  <header>
    <h1>注文管理画面</h1>
  </header>

  <main class="grid">
    <section class="card">
      <h2>管理者ログイン</h2>
      <div class="muted">Firestoreのルールにより、ログインしないと注文一覧は読めません。</div>

      <div style="height:12px"></div>
      <div class="row">
        <div>
          <div class="muted">メール</div>
          <input id="email" type="email" placeholder="admin@example.com">
        </div>
        <div>
          <div class="muted">パスワード</div>
          <input id="password" type="password" placeholder="••••••••">
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="row">
        <button id="loginBtn" class="btn">ログイン</button>
        <button id="logoutBtn" class="btn2" style="display:none;">ログアウト</button>
      </div>

      <div style="height:12px"></div>
      <div id="authState" class="muted">未ログイン</div>

      <hr style="border:none; border-top:1px solid #eef0f5; margin:16px 0;">

      <h2>表示フィルタ</h2>
      <div class="muted">ステータスで絞り込みできます。</div>
      <div style="height:10px"></div>
      <select id="filter">
        <option value="all">すべて</option>
        <option value="new">新規</option>
        <option value="done">完了</option>
        <option value="canceled">取消</option>
      </select>

      <div style="height:12px"></div>
      <div class="muted">入口リンク</div>
      <div style="margin-top:6px;">
        <a href="./order.html?table=1">注文（テーブル1例）</a>
      </div>
    </section>

    <section class="card">
      <h2>注文一覧</h2>
      <div id="info" class="muted">ログインするとリアルタイム表示します。</div>
      <div id="orders"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwehYqjyO7R982qHjTMiNGjQ2yPNEA7YU",
      authDomain: "order-app-ec18b.firebaseapp.com",
      projectId: "order-app-ec18b",
      storageBucket: "order-app-ec18b.firebasestorage.app",
      messagingSenderId: "756193856808",
      appId: "1:756193856808:web:f2200287017adaf895541d",
      measurementId: "G-84PBP7PZNM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authState = document.getElementById("authState");
    const infoEl = document.getElementById("info");
    const ordersEl = document.getElementById("orders");
    const filterEl = document.getElementById("filter");

    let unsub = null;
    let latestDocs = []; // for client-side filter

    function fmtTime(ts){
      if (!ts?.toDate) return "(時刻取得中)";
      return ts.toDate().toLocaleString("ja-JP");
    }

    function tag(status){
      if (status === "done") return `<span class="tag">完了</span>`;
      if (status === "canceled") return `<span class="tag" style="background:#fee2e2;color:#7f1d1d;">取消</span>`;
      return `<span class="tag">新規</span>`;
    }

    function renderList() {
      const f = filterEl.value;
      const docs = (f === "all") ? latestDocs : latestDocs.filter(x => (x.data.status ?? "new") === f);

      if (docs.length === 0) {
        ordersEl.innerHTML = `<div class="muted" style="margin-top:10px;">表示する注文がありません。</div>`;
        return;
      }

      ordersEl.innerHTML = docs.map(({ id, data }) => {
        const itemsHtml = (data.items || []).map(it => `<li>${it.name} × ${it.qty}</li>`).join("");
        const note = (data.note || "").trim();
        return `
          <div class="order" data-id="${id}">
            <div class="top">
              <div>
                <div style="font-weight:900; font-size:18px;">テーブル ${data.table ?? "-"}</div>
                <div class="muted">作成: ${fmtTime(data.createdAt)} ／ 更新: ${fmtTime(data.updatedAt)}</div>
              </div>
              <div>${tag(data.status ?? "new")}</div>
            </div>

            <div style="margin-top:10px;">
              <div style="font-weight:800;">注文内容</div>
              <ul>${itemsHtml || "<li>(商品なし)</li>"}</ul>
            </div>

            <div style="margin-top:10px;">
              <div><b>合計:</b> ${new Intl.NumberFormat("ja-JP").format(data.total ?? 0)} 円</div>
              ${note ? `<div class="muted" style="margin-top:6px;"><b>備考:</b> ${note}</div>` : ""}
            </div>

            <div class="actions">
              <button class="btn small" data-action="done">完了</button>
              <button class="danger small" data-action="canceled">取消</button>
              <button class="btn2 small" data-action="new">新規に戻す</button>
            </div>
          </div>
        `;
      }).join("");
    }

    async function setStatus(orderId, status) {
      const ref = doc(db, "orders", orderId);
      await updateDoc(ref, { status, updatedAt: serverTimestamp() });
    }

    ordersEl.addEventListener("click", async (e) => {
      const btn = e.target?.closest?.("button[data-action]");
      if (!btn) return;
      const wrap = e.target?.closest?.(".order");
      if (!wrap) return;
      const id = wrap.getAttribute("data-id");
      const status = btn.getAttribute("data-action");
      try {
        await setStatus(id, status);
      } catch (err) {
        infoEl.textContent = "更新エラー: " + (err?.message ?? String(err));
      }
    });

    filterEl.addEventListener("change", renderList);

    function startListen() {
      if (unsub) unsub();
      infoEl.textContent = "読み込み中…";

      const q = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(100));
      unsub = onSnapshot(q, (snap) => {
        latestDocs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        infoEl.textContent = `表示件数: ${latestDocs.length}（リアルタイム）`;
        renderList();
      }, (err) => {
        infoEl.textContent = "読み取りエラー: " + (err?.message ?? String(err));
      });
    }

    loginBtn.addEventListener("click", async () => {
      infoEl.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      } catch (err) {
        infoEl.textContent = "ログイン失敗: " + (err?.message ?? String(err));
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authState.textContent = `ログイン中: ${user.email ?? ""}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        startListen();
      } else {
        authState.textContent = "未ログイン";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        infoEl.textContent = "ログインするとリアルタイム表示します。";
        ordersEl.innerHTML = "";
        latestDocs = [];
        if (unsub) unsub();
        unsub = null;
      }
    });
  </script>
</body>
</html>
